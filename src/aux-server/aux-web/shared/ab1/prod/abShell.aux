{"version":2,"updates":[{"id":0,"timestamp":1708458739306,"update":"AaoB+PmM1gcAJwEEYm90cyQwMjgzNjVhNC0wMzZmLTQxZDAtOWFmMS03MTVhZDRmMmFhN2EBJwD4+YzWBwAGc3lzdGVtAgQA+PmM1gcBEWFiLnNoZWxsLnJlZ3VsYXRlJwD4+YzWBwAEZm9ybQIEAPj5jNYHEwdub3RoaW5nJwD4+YzWBwAMb25BbnlCb3REcmFnAgQA+PmM1gcbuwFALy9jb250cm9scyBncmlkIHNuYXAKaWYgKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkU25hcFN0YXRlKQp7CiAgICBvcy5hZGREcm9wU25hcCgiZ3JpZCIpOwp9CgovL2NvbnRyb2xzIGJvdCBzbmFwCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmFiQm90U25hcFN0YXRlKQp7CiAgICBvcy5hZGREcm9wU25hcCgiZmFjZSIpOwp9JwD4+YzWBwAIcmVtZW1iZXICBAD4+YzWB9cBKPCflJdlNTM4MGE2Yi04YjRkLTRhOGItOGIwNC01OGUxZWIwM2U1ZTcnAPj5jNYHAAhhYklnbm9yZQIEAPj5jNYH/gEEdHJ1ZSgA+PmM1gcADGFiQm90VmVyc2lvbgF9qAInAPj5jNYHAAdhYlNoZWxsAgQA+PmM1geEAgR0cnVlJwEEYm90cyQzNGMzYzIxMC01YmYxLTQ5Y2YtYjE1MS1lZTJkMDdmMGU2NzMBJwD4+YzWB4kCBnN5c3RlbQIEAPj5jNYHigIPYWIuc2hlbGwuY3JlYXRlJwD4+YzWB4kCBGZvcm0CBAD4+YzWB5oCB25vdGhpbmcnAPj5jNYHiQILZGVzY3JpcHRpb24CBAD4+YzWB6ICPUJvdCB1c2VkIHRvIGNyZWF0ZS9tYW5pZmVzdCBib3RzIGludG8gYW4gYWN0dWFsIHNjZW5lL3BvcnRhbC4nAPj5jNYHiQIMYWJDcmVhdGVCb3RzAgQA+PmM1gfgAqIeQC8vREVWIE5PVEU6IE5FRUQgVE8gVU5ERVJTVEFORCBXSEFUIFRPIERPIElGIEFOIEFSUkFZIElTIEdJVkVOCgovL2NoZWNrcyBmb3IgaW5pdGlhbCBib290IGJvb2xlYW4KbGV0IGluaXRpYWxCb290ID0gdGhhdC5pbml0aWFsQm9vdDsKLy9ib3RzIHRvIGJlIGdlbmVyYXRlZApsZXQgYm90RGF0YSA9IHRoYXQuYm90czsKLy93aGVyZSBkaWQgdGhlIGRhdGEgY29tZSBmcm9tIChvcHRpb25hbCkKbGV0IG9yaWdpbiA9IHRoYXQub3JpZ2luOwovL3ZlcnNpb24gb2YgdGhlIGRhdGEgKG9wdGlvbmFsKQpsZXQgdmVyc2lvbiA9IHRoYXQudmVyc2lvbjsKLy9pZE1hcCBhbmQgbmV3Qm90cyBhcmUgdXNlZCB0byBtYW5hZ2UgdGhlIGluY29taW5nIGJvdCBkYXRhCmxldCBpZE1hcCA9IG5ldyBNYXAoKTsKbGV0IG5ld0JvdHMgPSBbXTsKCi8vdGhpcyBsb29wIGNyZWF0ZXMgdGhlIG5ldyBib3RzIGFuZCB0aGVuIHBhY2thZ2VzIHRoZW0gZm9yIGFkZGl0aW9uYWwgcHJvY2Vzc2luZywgd2hpbGUgYWRkaW5nIGFueSBuZWVkZWQgYWRkaXRpb25hbCB0YWdzCmZvciAoY29uc3QgcHJvcGVydHkgaW4gYm90RGF0YSkKewogICAgY29uc3QgbmV3Qm90ID0gYm90RGF0YVtwcm9wZXJ0eV07CiAgICBjb25zdCBib3RUb3RhbCA9IE9iamVjdC5rZXlzKGJvdERhdGEpLmxlbmd0aDsKICAgIGNvbnN0IGFiSURPcmlnaW4gPSB7YWJJRE9yaWdpbjogb3JpZ2lufTsKICAgIGNvbnN0IGFiR3JpZEZvY3VzID0gbGlua3MucmVtZW1iZXIudGFncy5hYkdyaWRGb2N1czsKCiAgICBpZiAobmV3Qm90LnRhZ3MpIAogICAgewogICAgICAgIGlmIChuZXdCb3QudGFncy5jcmVhdG9yKSAKICAgICAgICB7CiAgICAgICAgICAgIGFiSURPcmlnaW4ub2xkQ3JlYXRvciA9IG5ld0JvdC50YWdzLmNyZWF0b3I7CiAgICAgICAgfQoKICAgICAgICBsZXQgdGFyZ2V0UG9zaXRpb247CgogICAgICAgIHRyeSAKICAgICAgICB7CiAgICAgICAgICAgIGlmICgoYm90VG90YWwgPCAyIHx8IGJvdFRvdGFsIDwgMyAmJiBib3REYXRhLmFiWFBCb3QgIT0gbnVsbCkgJiYgYWJHcmlkRm9jdXMpIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsZXQgdGFyZ2V0RGltZW5zaW9uID0gYWJHcmlkRm9jdXMuZGltZW5zaW9uOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB0YXJnZXRQb3NpdGlvbiA9IHsgW3RhcmdldERpbWVuc2lvbl06IHRydWUsIFt0YXJnZXREaW1lbnNpb24gKyAiWCJdOiBhYkdyaWRGb2N1cy5wb3NpdGlvbi54LCBbdGFyZ2V0RGltZW5zaW9uICsgIlkiXTogYWJHcmlkRm9jdXMucG9zaXRpb24ueSB9OwogICAgICAgICAgICB9CgogICAgICAgICAgICBsZXQgYiA9IGNyZWF0ZShuZXdCb3QudGFncywgdGFyZ2V0UG9zaXRpb24sIGFiSURPcmlnaW4pOwoKICAgICAgICAgICAgaWRNYXAuc2V0KGJvdERhdGFbcHJvcGVydHldLmlkLCBiLmlkKTsKICAgICAgICAgICAgbmV3Qm90cy5wdXNoKGIpOwoKICAgICAgICAgICAgaWYgKGIudGFncy5jcmVhdG9yID09IHRoaXNCb3QuaWQpIAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBiLnRhZ3MuY3JlYXRvciA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY2F0Y2ggKGVycm9yKSAKICAgICAgICB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCJpbnZhbGlkIGJvdCIsIGVycm9yKTsKICAgICAgICB9CiAgICB9CiAgICBlbHNlIAogICAgewogICAgICAgIGNvbnNvbGUubG9nKCJza2lwcGVkIGJvdDogIiArIG5ld0JvdCk7CiAgICB9Cn0KCi8vYXJyYXkgb2YgdGFnIHJlbGF0aW9uc2hpcHMgdG8gYmUgcHJlc2VydmVkCmxldCBsaW5rVGFncyA9IFsibGluayIsICJjcmVhdG9yIiwgImNvbmZpZ0JvdCIsICJsaW5lVG8iLCAidHJhbnNmb3JtZXIiXTsKCi8vdGhpcyBsb29wIGNvbnRhaW5zIHRoZSBsb2dpYyBmb3IgcHJlc2VydmluZyB0aGUgbGlua1RhZ3MKZm9yIChsZXQgbmV3Qm90IG9mIG5ld0JvdHMpIAp7CiAgICBmb3IgKGxldCB0YWcgb2YgbGlua1RhZ3MpIAogICAgewogICAgICAgIGxldCB2YWx1ZSA9IG5ld0JvdC50YWdzW3RhZ107CgogICAgICAgIGlmICh0YWcgPT0gImNyZWF0b3IiKSAKICAgICAgICB7CiAgICAgICAgICAgIHZhbHVlID0gbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvcjsKICAgICAgICAgICAgbmV3Qm90LnRhZ3Mub2xkQ3JlYXRvciA9IG51bGw7CiAgICAgICAgfQoKICAgICAgICB1cGRhdGVCb3RMaW5rcyhuZXdCb3QsIGlkTWFwKTsKCiAgICAgICAgaWYgKHZhbHVlKSAKICAgICAgICB7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxldCBuZXdWYWx1ZSA9IHZhbHVlLm1hcChpZCA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlkTWFwLmdldChpZCkgfHwgaWQ7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld1ZhbHVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnN0IG5ld0lEID0gaWRNYXAuZ2V0KHZhbHVlKTsKCiAgICAgICAgICAgICAgICBpZiAobmV3SUQpIAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIG5ld0JvdC5yYXdbdGFnXSA9IG5ld0lEOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgovL3RvYXN0cyBmb3IgaGF0Y2hlcywgYnV0IG9ubHkgb24gYnVpbGRlcgppZiAoY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlID09IG51bGwgJiYgIWNvbmZpZ0JvdC50YWdzLnBoICYmIGJ1aWxkZXJWZXJzaW9uID09ICJidWlsZGVyIikgCnsKICAgIG9zLnRvYXN0KCJoYXRjaGVkICIgKyBvcmlnaW4gKyAiIHYiICsgdmVyc2lvbik7Cn0KCmlmIChvcmlnaW4pCnsKICAgIGxldCBhYkFydGlmYWN0ID0ge307CgogICAgYWJBcnRpZmFjdC5hYiA9IHRydWU7CiAgICBhYkFydGlmYWN0LmFiQXJ0aWZhY3QgPSB0cnVlOwogICAgLy9hYkFydGlmYWN0LnNwYWNlID0gImxvY2FsIjsKICAgIGFiQXJ0aWZhY3QuYWJJZ25vcmUgPSB0cnVlOwogICAgYWJBcnRpZmFjdC5vcmlnaW5fYWIgPSBvcmlnaW47CiAgICBhYkFydGlmYWN0Lm9yaWdpbl92ZXJzaW9uID0gdmVyc2lvbjsKICAgIGFiQXJ0aWZhY3Qub3JpZ2luX3JlY29yZCA9IHRoYXQucmVjb3JkOwogICAgYWJBcnRpZmFjdC5mb3JtID0gImVnZyI7CiAgICBhYkFydGlmYWN0LmxhYmVsID0gb3JpZ2luICsgIiB2IiArIHZlcnNpb247CiAgICBhYkFydGlmYWN0LmFiWCA9IGdldEJvdHMoImFiIikubGVuZ3RoICogMS41OwoKICAgIGNyZWF0ZShhYkFydGlmYWN0KTsKfQoKLy9hZGRpdGlvbmFsIGhhdGNoIGRhdGEKY29uZmlnQm90LnRhZ3MubGFzdEVnZ0hhdGNoZWQgPSBvcmlnaW47CgovL2luaXRpYWwgYm9vdCBsb2dpYwppZiAoaW5pdGlhbEJvb3QpIAp7CiAgICBsZXQgcHJlaGF0Y2ggPSBhd2FpdCBzaG91dCgib25QcmVIYXRjaCIsIHsgYWI6IG9yaWdpbiB9KVswXTsKCiAgICBpZiAoIXByZWhhdGNoKSAKICAgIHsKICAgICAgICBhYkluc3RNZW1vcnkudGFncy5iYXNlQUIgPSBvcmlnaW47CiAgICB9CiAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IG9yaWdpbjsKfQoKLy9vbkVnZ0hhdGNoIGZvciBhbGwganVzdCBoYXRjaGVkIGJvdHMKd2hpc3BlcihuZXdCb3RzLCAib25FZ2dIYXRjaCIsIHthYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdH0pOwoKLy9vbkFiQWRkZWQgZm9yIGFsbCBib3RzIGluIHRoZSBleHBlcmllbmNlCnN1cGVyU2hvdXQoIm9uQWJBZGRlZCIsIHthYjogb3JpZ2luLCB2ZXJzaW9uOiB2ZXJzaW9uLCBpbnN0OiBhYi50YWdzLmFiSW5zdH0pOycA+PmM1geJAghyZW1lbWJlcgIEAPj5jNYHgyEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA+PmM1geJAglvbkFiQWRkZWQCBAD4+YzWB6ohckAvL3Nob3V0KCJvbkFiQWRkZWQiLCB7YWI6IG9yaWdpbiwgdmVyc2lvbjogdmVyc2lvbn0pOwoKY29uc29sZS5sb2coImFiOiAiICsgdGhhdC5hYiwgInZlcnNpb246ICIgKyB0aGF0LnZlcnNpb24pOycA+PmM1geJAghhYklnbm9yZQIEAPj5jNYHnSIEdHJ1ZSgA+PmM1geJAgxhYkJvdFZlcnNpb24BfagCJwD4+YzWB4kCB2FiU2hlbGwCBAD4+YzWB6MiBHRydWUnAQRib3RzJDc2YWYwNDkxLTM5MTktNDk4NC1hYTgyLTIyYzc0MmY0MjYzZgEnAPj5jNYHqCIGc3lzdGVtAgQA+PmM1gepIg5hYi5zaGVsbC5zdG9yZScA+PmM1geoIgRmb3JtAgQA+PmM1ge4Igdub3RoaW5nJwD4+YzWB6giC2Rlc2NyaXB0aW9uAgQA+PmM1gfAIj9UaGlzIHNraWxsIGlzIG1lYW50IHRvIGJlIGEgY29uZmlndXJhYmxlIG1lYW5zIHRvIHB1Ymxpc2ggZGF0YS4nAPj5jNYHqCIPYWJQdWJsaXNoUmVjb3JkAgQA+PmM1geAI9wFQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgpsZXQgcHVibGljID0gdGhhdC5wdWJsaWM7CmxldCByZWNvcmREYXRhID0gdGhhdC5kYXRhOwpsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKbGV0IGVuZHBvaW50ID0gdGhhdC5lbmRwb2ludCA/IHRoYXQuZW5kcG9pbnQgOiBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPz8gYXV0aEJvdC5pZDsKCmlmICghcmVjb3JkRGF0YSkKewogICAgcmV0dXJuICJubyBkYXRhIHN1cHBsaWVkIjsKfQoKaWYgKHB1YmxpYykKewogICAgcmVjb3JkRGF0YSA9IGF3YWl0IG9zLnJlY29yZERhdGEodXNlclJlY29yZCwgcmVjb3JkTmFtZSwgcmVjb3JkRGF0YSwge2VuZHBvaW50OiBlbmRwb2ludCwgbWFya2VyczogWyJwdWJsaWNSZWFkIl19KTsKfQplbHNlCnsgICAgCiAgICByZWNvcmREYXRhID0gYXdhaXQgb3MucmVjb3JkRGF0YSh1c2VyUmVjb3JkLCByZWNvcmROYW1lLCByZWNvcmREYXRhLCB7ZW5kcG9pbnQ6IGVuZHBvaW50LCBtYXJrZXJzOiBbcmVjb3JkTmFtZV19KTsKfQoKaWYgKHJlY29yZERhdGEuc3VjY2VzcykKewogICAgYWIubG9nKCJhYjogZGF0YSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2coImFiOiBkYXRhIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIHJlY29yZERhdGE7JwD4+YzWB6giDWFiUHVibGlzaEZpbGUCBAD4+YzWB90olQVAYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBmaWxlID0gdGhhdC5maWxlOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGVOYW1lOwpsZXQgbWltZVR5cGUgPSB0aGF0Lm1pbWVUeXBlOwpsZXQgdXNlclJlY29yZCA9IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8/IGF1dGhCb3QuaWQ7CgppZiAoIWZpbGUpCnsKICAgIHJldHVybiAibm8gZmlsZSBzdXBwbGllZCI7Cn0KCmxldCBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKICAgIAppZiAoIWZpbGVVcGxvYWQuc3VjY2VzcykgCnsKICAgIGF3YWl0IG9zLmdyYW50SW5zdEFkbWluUGVybWlzc2lvbih1c2VyUmVjb3JkKTsKCiAgICBmaWxlVXBsb2FkID0gYXdhaXQgb3MucmVjb3JkRmlsZSh1c2VyUmVjb3JkLCBmaWxlLCB7ZGVzY3JpcHRpb246IGZpbGVOYW1lLCBtaW1lVHlwZTogbWltZVR5cGV9KTsKfQoKaWYgKGZpbGVVcGxvYWQuc3VjY2VzcykKewogICAgYWIubG9nKCJhYjogZmlsZSByZWNvcmRlZCB0byAiICsgdXNlclJlY29yZCk7Cn0KZWxzZQp7CiAgICBhYi5sb2coImFiOiBmaWxlIGZhaWxlZCB0byByZWNvcmQiKTsKfQoKcmV0dXJuIGZpbGVVcGxvYWQ7JwD4+YzWB6giEGFiQ29yZU1lbnVBY3Rpb24CBAD4+YzWB/MtTUBhd2FpdCBvcy5yZXF1ZXN0QXV0aEJvdCgpOwoKLy9zZXQgdXAgdGhlIHB1Ymxpc2ggbWVudQp0aGlzQm90Lm9uU3RvcmVNZW51KCk7JwD4+YzWB6giC29uU3RvcmVNZW51AgQA+PmM1gfBLsNcQGxldCBwb3NzaWJsZVB1Ymxpc2hCb3QgPSBsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzOwoKc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gImFiTWVudSI7CgpsaW5rcy5tZW51Lm1hc2tzLm9uR3JpZENsaWNrID0gIkAgc2hvdXQoJ2FiTWVudVJlZnJlc2gnKTsgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7IjsKCmNvbnN0IHV1YWIgPSBsaW5rcy5yZW1lbWJlci50YWdzLnV1YWIgPyB0cnVlIDogZmFsc2U7CgpsZXQgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5hYk1lbnUgPSB0cnVlOwptZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDk7Cm1lbnVCdXR0b24uYWJNZW51UmVmcmVzaCA9ICJAIGRlc3Ryb3kodGhpc0JvdCk7IjsKbWVudUJ1dHRvbi5sYWJlbCA9ICJkb3dubG9hZCI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAiZ2V0X2FwcCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLm1hbmlmZXN0YXRpb24gPSB0YWdzLm1hbmlmZXN0YXRpb247Cm1lbnVCdXR0b24ub25DbGljayA9IGBAIGxpbmtzLm1hbmFnZXIuYWJEb3dubG9hZCgpO2A7CgovL2NyZWF0ZSBkb3dubG9hZCBidXR0b24KbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7CgppZiAoIWF1dGhCb3QpCnsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSAicGxlYXNlIHNpZ24gaW4gdG8gYWNjZXNzIHNoYXJlIGZlYXR1cmVzIjsKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAibG9jayI7CiAgICBtZW51QnV0dG9uLm9uQ2xpY2sgPSAiQCBvcy5yZXF1ZXN0QXV0aEJvdCgpIjsKCiAgICAvL2NyZWF0ZSBsb2dpbiBtZXNzYWdlCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCiAgICByZXR1cm47Cn0KZWxzZSBpZiAoYXV0aEJvdC50YWdzLnN1YnNjcmlwdGlvblRpZXIgPT0gIkZyZWVQbGF5IikKewogICAgbWVudUJ1dHRvbi5sYWJlbCA9ICJwbGVhc2UgdXBncmFkZSB5b3VyIHN1YnNjcmlwdGlvbiB0byBhY2Nlc3Mgc2hhcmUgZmVhdHVyZXMiOwogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9ICJsb2NrIjsKICAgIG1lbnVCdXR0b24ub25DbGljayA9IG51bGw7CgogICAgLy9jcmVhdGUgbG9naW4gbWVzc2FnZQogICAgbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24obWVudUJ1dHRvbik7CgogICAgcmV0dXJuOwp9CgppZiAoIXV1YWIpCnsKICAgIGxldCB1c2VyU3R1ZGlvcyA9IGNvbmZpZ0JvdC50YWdzLnVzZXJfc3R1ZGlvczsKCiAgICBpZiAoIXVzZXJTdHVkaW9zKQogICAgewogICAgICAgIHVzZXJTdHVkaW9zID0gYXdhaXQgb3MubGlzdFVzZXJTdHVkaW9zKCk7CiAgICB9CiAgICAKICAgIGlmICh1c2VyU3R1ZGlvcy5zdWNjZXNzKQogICAgewogICAgICAgIGNvbnN0IGFjdGl2ZVN0dWRpbyA9IHVzZXJTdHVkaW9zLnN0dWRpb3MuZmluZEluZGV4KHN0dWRpbyA9PiBzdHVkaW8uc3R1ZGlvSWQgPT0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQpOwogICAgICAgIGxldCBiYXNlU3R1ZGlvID0gYXV0aEJvdC5pZDsKCiAgICAgICAgaWYgKGJhc2VTdHVkaW8gPT0gYXV0aEJvdC5pZCkKICAgICAgICB7CiAgICAgICAgICAgIGJhc2VTdHVkaW8gPSAicGxheWVyIjsKICAgICAgICB9CgogICAgICAgIGlmIChhY3RpdmVTdHVkaW8gPT0gLTEgJiYgYmFzZVN0dWRpbyAhPSAicGxheWVyIikKICAgICAgICB7CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYmFzZVN0dWRpbzsKICAgICAgICB9CgogICAgICAgIGlmIChjb25maWdCb3QudGFncy5zdHVkaW8gJiYgIWFjdGl2ZVN0dWRpbykKICAgICAgICB7CiAgICAgICAgICAgIGNvbnN0IHN0dWRpb01hdGNoID0gdXNlclN0dWRpb3Muc3R1ZGlvcy5maW5kSW5kZXgoc3R1ZGlvID0+IHN0dWRpby5zdHVkaW9JZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCgogICAgICAgICAgICBpZiAoc3R1ZGlvTWF0Y2ggIT0gLTEpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGJhc2VTdHVkaW8gPSBiYXNlU3R1ZGlvOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBjb25zdCBzdHVkaW9MYWJlbCA9IGFjdGl2ZVN0dWRpbyA9PSAtMSA/IGJhc2VTdHVkaW8gOiB1c2VyU3R1ZGlvcy5zdHVkaW9zW2FjdGl2ZVN0dWRpb10uZGlzcGxheU5hbWU7CiAgICAgICAgCiAgICAgICAgbWVudUJ1dHRvbi5sYWJlbCA9ICJzdHVkaW89IiArIHN0dWRpb0xhYmVsOwogICAgICAgIG1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gLTM7CiAgICAgICAgbWVudUJ1dHRvbi5zdHVkaW9JbmZvcm1hdGlvbiA9IHVzZXJTdHVkaW9zOwogICAgICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAiaW52ZW50b3J5XzIiOwogICAgICAgIG1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDlweCA5cHgiLCAibWFyZ2luLXRvcCI6ICI2cHgifWA7CiAgICAgICAgbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICAgICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgbGlua3MubWFuYWdlci5zdHVkaW9TZWxlY3QodGFncy5zdHVkaW9JbmZvcm1hdGlvbik7YDsKICAgICAgICAKICAgICAgICAvL2NyZWF0ZSBzdHVkaW8gc2VsZWN0IGJ1dHRvbgogICAgICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKICAgICAgICBtZW51QnV0dG9uLnN0dWRpb0luZm9ybWF0aW9uID0gbnVsbDsKICAgIH0KCiAgICBtZW51QnV0dG9uLmxhYmVsID0gInB1Ymxpc2ggcGF0dGVybiI7IAogICAgbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAxOwogICAgbWVudUJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJjZW50ZXIiOwogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9IG51bGw7CiAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiOXB4IDlweCAwcHggMHB4IiwgIm1hcmdpbi10b3AiOiAiNnB4In1gOwogICAgbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICBtZW51QnV0dG9uLnBvaW50YWJsZSA9IGZhbHNlOwogICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gbnVsbDsKICAgIG1lbnVCdXR0b24uc2NhbGVZID0gMC43NTsKICAgIAogICAgLy9jcmVhdGUgcHVibGlzaCBsYWJlbCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKICAgIG1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMTsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSAiZW5jcnlwdCI7CiAgICBtZW51QnV0dG9uLmxhYmVsQWxpZ25tZW50ID0gImxlZnQiOwogICAgbWVudUJ1dHRvbi5tZW51SXRlbVN0eWxlID0gYPCfp6wgeyJib3JkZXItcmFkaXVzIjogIjBweCAwcHggMHB4IDBweCIsICJtYXJnaW4tdG9wIjogIjBweCJ9YDsKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiOwogICAgbWVudUJ1dHRvbi5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgIG1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgbWVudUJ1dHRvbi5zY2FsZVkgPSAxOwogICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgaWYodGFncy5lbmNyeXB0U3RhdGUpCiAgICB7CiAgICAgICAgdGFncy5lbmNyeXB0U3RhdGUgPSBmYWxzZTsKICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgICAgICBjb25maWdCb3QudGFncy5lbmNyeXB0aW9uID0gbnVsbDsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLmVuY3J5cHRTdGF0ZSA9IHRydWU7CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwogICAgICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSB0cnVlOwogICAgfWA7CgogICAgLy9jcmVhdGUgZW5jcnlwdCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKICAgIG1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gMjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSAiaXNQdWJsaWMiOwogICAgbWVudUJ1dHRvbi5sYWJlbEFsaWdubWVudCA9ICJsZWZ0IjsKICAgIG1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICIwcHggMHB4IDBweCAwcHgiLCAibWFyZ2luLXRvcCI6ICIwcHgifWA7CiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gImNoZWNrX2JveF9vdXRsaW5lX2JsYW5rIjsKICAgIG1lbnVCdXR0b24ucHVibGljU3RhdGUgPSBmYWxzZTsKICAgIG1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwogICAgbWVudUJ1dHRvbi5zY2FsZVkgPSAxOwogICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgaWYodGFncy5wdWJsaWNTdGF0ZSkKICAgIHsKICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gZmFsc2U7CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljID0gbnVsbDsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLnB1YmxpY1N0YXRlID0gdHJ1ZTsKICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveCc7CiAgICAgICAgY29uZmlnQm90LnRhZ3MucHVibGljID0gdHJ1ZTsKICAgIH1gOwoKICAgIC8vY3JlYXRlIHB1YmxpYyBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKICAgIG1lbnVCdXR0b24uYWJNZW51ID0gbnVsbDsKICAgIG1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDBweCAwcHgiLCAibWFyZ2luLXRvcCI6ICI2cHgifWA7CiAgICBtZW51QnV0dG9uLmRpbWVuc2lvbiA9ICJhYk1lbnUiOwogICAgbWVudUJ1dHRvbi5vbktleURvd24gPSBgQAogICAgICAgIGlmICh0aGF0LmtleXNbMF0gPT0gIlNoaWZ0IikKICAgICAgICB7CiAgICAgICAgICAgIHRhZ3NbdGFncy5kaW1lbnNpb25dID0gdHJ1ZTsKICAgICAgICB9YDsKICAgIG1lbnVCdXR0b24ub25LZXlVcCA9IGBACiAgICAgICAgaWYgKHRoYXQua2V5c1swXSA9PSAiU2hpZnQiKQogICAgICAgIHsKICAgICAgICAgICAgdGFnc1t0YWdzLmRpbWVuc2lvbl0gPSBmYWxzZTsKICAgICAgICB9YDsKICAgIG1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gLTY7CiAgICBtZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAiY2hlY2tfYm94IjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSAiY3VycmVudCB2ZXJzaW9uIjsKICAgIG1lbnVCdXR0b24ub3RoZXJPcHRpb25DbGljayA9IGBAIGlmICh0aGF0ID09IHRoaXNCb3QuaWQpe3JldHVybjt9CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3hfb3V0bGluZV9ibGFuayc7CiAgICBgOwogICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAKICAgICAgICB0YWdzLmxhYmVsID0gJ2N1cnJlbnQgdmVyc2lvbic7CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwoKICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CgogICAgICAgIHNob3V0KCJvdGhlck9wdGlvbkNsaWNrIiwgdGhpc0JvdC5pZCk7CiAgICBgOwoKICAgIC8vY3JlYXRlIGN1cnJlbnQgdmVyc2lvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKCiAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCAwcHggMHB4IiwgIm1hcmdpbi10b3AiOiAiMHB4In1gOwogICAgbWVudUJ1dHRvbi5idXR0b25TdGF0ZSA9IG51bGw7CiAgICBtZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IC01OwogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9ICJjaGVja19ib3hfb3V0bGluZV9ibGFuayI7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gImZlZWRiYWNrIHZlcnNpb24iOwogICAgbWVudUJ1dHRvbi5vdGhlck9wdGlvbkNsaWNrID0gYEAgaWYgKHRoYXQgPT0gdGhpc0JvdC5pZCl7cmV0dXJuO30KICAgICAgICB0YWdzLmZvcm1BZGRyZXNzID0gJ2NoZWNrX2JveF9vdXRsaW5lX2JsYW5rJzsKICAgIGA7CiAgICBtZW51QnV0dG9uLm9uQ2xpY2sgPSBgQAogICAgICAgIHRhZ3MubGFiZWwgPSAnZmVlZGJhY2sgdmVyc2lvbic7CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwoKICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICJmZWVkYmFjayI7CgogICAgICAgIHNob3V0KCJvdGhlck9wdGlvbkNsaWNrIiwgdGhpc0JvdC5pZCk7CiAgICBgOwoKICAgIC8vY3JlYXRlIGZlZWRiYWNrIHZlcnNpb24gYnV0dG9uCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCiAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA4cHggOHB4IiwgIm1hcmdpbi10b3AiOiAiMHB4In1gOwogICAgbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAtNDsKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAiY2hlY2tfYm94X291dGxpbmVfYmxhbmsiOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9ICJzdGFibGUgdmVyc2lvbiI7CiAgICBtZW51QnV0dG9uLm90aGVyT3B0aW9uQ2xpY2sgPSBgQCBpZiAodGhhdCA9PSB0aGlzQm90LmlkKXtyZXR1cm47fQogICAgICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSAnY2hlY2tfYm94X291dGxpbmVfYmxhbmsnOwogICAgYDsKICAgIG1lbnVCdXR0b24ub25DbGljayA9IGBACiAgICAgICAgdGFncy5sYWJlbCA9ICdzdGFibGUgdmVyc2lvbic7CiAgICAgICAgdGFncy5mb3JtQWRkcmVzcyA9ICdjaGVja19ib3gnOwoKICAgICAgICBjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9ICJzdGFibGUiOwoKICAgICAgICBzaG91dCgib3RoZXJPcHRpb25DbGljayIsIHRoaXNCb3QuaWQpOwogICAgYDsKCiAgICAvL2NyZWF0ZSBzdGFibGUgdmVyc2lvbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9CgptZW51QnV0dG9uLm90aGVyT3B0aW9uQ2xpY2sgPSBudWxsOwptZW51QnV0dG9uLmRpbWVuc2lvbiA9IG51bGw7Cm1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5vbktleURvd24gPSBudWxsOwptZW51QnV0dG9uLm9uS2V5VXAgPSBudWxsOwptZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDI7Cm1lbnVCdXR0b24uYnV0dG9uU3RhdGUgPSBudWxsOwptZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9ICJlZ2ciOwoKaWYgKHV1YWIpCnsKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSAicXJfY29kZV9zY2FubmVyIjsKICAgIG1lbnVCdXR0b24ub25DbGljayA9IGBACiAgICAgICAgdHJ5CiAgICAgICAgewogICAgICAgICAgICBjb25maWdCb3QudGFncy51dWFiU2NhbiA9IHRydWU7CgogICAgICAgICAgICBvcy5vcGVuUVJDb2RlU2Nhbm5lcigpOwoKICAgICAgICAgICAgb3MudG9hc3QoInBsZWFzZSBzY2FuIHlvdXIgcHJhY3RpY2UgcGVybWl0Iik7CiAgICAgICAgfQogICAgICAgIGNhdGNoCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgicXIgY29kZSBzY2FuIG5vdCBzdXBwb3J0ZWQgb24gdGhpcyBkZXZpY2UiKTsKCiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnV1YWJTY2FuID0gbnVsbDsKICAgICAgICB9CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgYDsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSAicHVibGlzaCBhYiI7Cn0KZWxzZQp7CiAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiMHB4IDBweCA5cHggOXB4IiwgIm1hcmdpbi10b3AiOiAiMHB4In1gOwogICAgbWVudUJ1dHRvbi5mb3JtID0gImlucHV0IjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBudWxsOwogICAgbWVudUJ1dHRvbi5tZW51SXRlbVNob3dTdWJtaXRXaGVuRW1wdHkgPSB0cnVlOwogICAgbWVudUJ1dHRvbi5tZW51SXRlbVRleHQgPSAhbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cyA/IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYmFzZUFCIDogbGlua3MucmVtZW1iZXIubGlua3MuYWJCb3RGb2N1cy5pZDsKICAgIG1lbnVCdXR0b24udGFyZ2V0Qm90ID0gZ2V0TGluayhwb3NzaWJsZVB1Ymxpc2hCb3QpOwogICAgbWVudUJ1dHRvbi5vblN1Ym1pdCA9IGBAIGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2ggPSB0cnVlOyAgIAoKICAgICAgICBpZiAodGhhdC50ZXh0ID09IG51bGwgJiYgbGlua3MucmVtZW1iZXIudGFncy5iYXNlQUIgJiYgIWxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCiAgICAgICAgewogICAgICAgICAgICB0aGF0LnRleHQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQjsKICAgICAgICB9CgogICAgICAgIGlmICh0aGF0LnRleHQpCiAgICAgICAgewogICAgICAgICAgICBsaW5rcy5tYW5hZ2VyLmFiUHVibGlzaEFCKHthYjogdGhhdC50ZXh0LCBtYW51YWxQdWJsaXNoOiB0cnVlLCBib3Q6IGxpbmtzLnRhcmdldEJvdH0pOwogICAgICAgIH0KICAgICAgICBlbHNlCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgiYWIgbm90IHNwZWNpZmllZCIpOwoKICAgICAgICAgICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICAgICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwogICAgICAgIH0KICAgIGA7Cn0KCi8vY3JlYXRlIHB1Ymxpc2ggYnV0dG9uCmxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCnsKICAgIG1lbnVCdXR0b24uYWJNZW51U29ydE9yZGVyID0gODsKICAgIG1lbnVCdXR0b24uZm9ybSA9IG51bGw7CiAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiOXB4IDlweCA5cHggOXB4IiwgIm1hcmdpbi10b3AiOiAiNnB4In1gOwogICAgbWVudUJ1dHRvbi5sYWJlbCA9ICJjb3B5IHRvIGNsaXBib2FyZCI7CiAgICBtZW51QnV0dG9uLmZvcm1BZGRyZXNzID0gImZpbGVfY29weSI7CiAgICBtZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgIG1lbnVCdXR0b24udGFyZ2V0Qm90ID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJvdEZvY3VzOwogICAgbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgbGV0IHNlbGVjdGVkQm90ID0gbGlua3MudGFyZ2V0Qm90OwogICAgbGV0IHByZXBwZWRCb3QgPSBKU09OLnN0cmluZ2lmeShzZWxlY3RlZEJvdCk7CiAgICBsZXQgc3RhdGUgPSB7fQoKICAgIHN0YXRlW2FiSW5zdE1lbW9yeS50YWdzLmFiRm9jdXNEYXRhXSA9IHNlbGVjdGVkQm90OwoKICAgIGxldCBuZXdGaWxlID0ge30KICAgIG5ld0ZpbGUudmVyc2lvbiA9IDE7CiAgICBuZXdGaWxlLnN0YXRlID0gc3RhdGU7CgogICAgdmFyIGZvcm1hdHRlZEZpbGUgPSBKU09OLnN0cmluZ2lmeShuZXdGaWxlKTsKCiAgICBvcy5zZXRDbGlwYm9hcmQoZm9ybWF0dGVkRmlsZSk7CgogICAgb3MudG9hc3QoImJvdCBjb3BpZWQgdG8gY2xpcGJvYXJkIik7CgogICAgc2hvdXQoImFiTWVudVJlZnJlc2giKTsKCiAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKICAgIGA7CiAgICAKICAgIC8vY3JlYXRlICBjb3B5IHRvIGNsaXBib2FyZCBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9CmVsc2UgaWYgKCF1dWFiKQp7CiAgICBtZW51QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDEwOwogICAgbWVudUJ1dHRvbi5mb3JtID0gbnVsbDsKICAgIG1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IGDwn6esIHsiYm9yZGVyLXJhZGl1cyI6ICI5cHggOXB4IDlweCA5cHgiLCAibWFyZ2luLXRvcCI6ICIzcHgifWA7CiAgICBtZW51QnV0dG9uLmxhYmVsID0gInNjYW4iOwogICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9ICJxcl9jb2RlX3NjYW5uZXIiOwogICAgbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7CiAgICBtZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IHRydWU7IG9zLm9wZW5RUkNvZGVTY2FubmVyKCk7YDsKCiAgICAvL2NyZWF0ZSAgc2NhbiBidXR0b24KICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwoKICAgIC8vTkVFRCBUTyBVUERBVEUKICAgIGlmIChjb25maWdCb3QudGFncy5naWcpCiAgICB7CiAgICAgICAgbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAtNTsKICAgICAgICBtZW51QnV0dG9uLm1lbnVJdGVtU3R5bGUgPSBg8J+nrCB7ImJvcmRlci1yYWRpdXMiOiAiOXB4IDlweCA5cHggOXB4IiwgIm1hcmdpbi10b3AiOiAiM3B4In1gOwogICAgICAgIG1lbnVCdXR0b24ubGFiZWwgPSAic3VibWl0IGdpZyI7CiAgICAgICAgbWVudUJ1dHRvbi5mb3JtQWRkcmVzcyA9ICJzZW5kIjsKICAgICAgICBtZW51QnV0dG9uLmNvbG9yID0gbGlua3MucmVtZW1iZXIudGFncy5hYkJhc2VTdHJva2VDb2xvcjsKICAgICAgICBtZW51QnV0dG9uLm9uQ2xpY2sgPSBgQCBzaG91dCgiYWJDb2xsYWJTdWJtaXQiKTtgOwoKICAgICAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKICAgIH0KfQoKbGV0IGhvc3RCdXR0b24gPSB7fTsKCmlmIChsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKewogICAgaG9zdEJ1dHRvbi5sYWJlbCA9ICJqb2luIGNvZGU6ICIgKyBsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRC5zdWJzdHJpbmcoMCwzKSArICItIiArIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElELnN1YnN0cmluZygzKTsKfQplbHNlCnsKICAgIGhvc3RCdXR0b24ubGFiZWwgPSAiZ2VuZXJhdGUgam9pbiBjb2RlIjsKfQoKaG9zdEJ1dHRvbi5hYk1lbnUgPSB0cnVlOwpob3N0QnV0dG9uLmFiTWVudVNvcnRPcmRlciA9IDUwOwpob3N0QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cmhvc3RCdXR0b24uZm9ybUFkZHJlc3MgPSAiZ3JvdXBfYWRkIjsKaG9zdEJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cmhvc3RCdXR0b24ubGVhcm4gPSB0YWdzLmxlYXJuOwpob3N0QnV0dG9uLnJlbWVtYmVyID0gdGFncy5yZW1lbWJlcjsKaG9zdEJ1dHRvbi5vbkNsaWNrID0gYEAgbGlua3MubGVhcm4uYWJDcmVhdGVIb3N0KHRoaXNCb3QpOwoKaWYgKCFsaW5rcy5yZW1lbWJlci50YWdzLmhvc3RJRCkKewogICAgdGFncy5sYWJlbCA9ICdnZW5lcmF0aW5nIGNvZGUgbm93JzsKfWA7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihob3N0QnV0dG9uKTsvL2dlbmVyYXRlIGEgaG9zdCBidXR0b24nAPj5jNYHqCIOYWJDb3JlTWVudUljb24CBAD4+YzWB+2KAQlpb3Nfc2hhcmUnAPj5jNYHqCIPYWJDb3JlTWVudUxhYmVsAgQA+PmM1gf3igEFc2hhcmUnAPj5jNYHqCITYWJDb3JlTWVudVNvcnRPcmRlcgIEAPj5jNYH/YoBATMnAPj5jNYHqCIIcmVtZW1iZXICBAD4+YzWB/+KASjwn5SXZTUzODBhNmItOGI0ZC00YThiLThiMDQtNThlMWViMDNlNWU3JwD4+YzWB6giC2FiUHVibGlzaEFCAgQA+PmM1gemiwGQJ0AvL3Nob3V0KCJhYlB1Ymxpc2hBQiIsIHthYjogIiIsIGtleTogIiIsIHRhcmdldDogIiJ9KTsKYWIubG9nKCJhYjogcHVibGlzaGluZyAiICsgdGhhdC5hYik7CgpsZXQgcHJvZ3Jlc3NCdXR0b247CgovL2Rlc3Ryb3kgcHJldmlvdXMgeHAgYm90CmlmIChnZXRCb3QoInN5c3RlbSIsICJhYi5wYXR0ZXJuLmFiWFBCb3QiKSkKewogICAgZGVzdHJveShnZXRCb3QoInN5c3RlbSIsICJhYi5wYXR0ZXJuLmFiWFBCb3QiKSk7Cn0KCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgovL2NsZWFyIGFiIGJ1aWxkZXIKaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24pCnsKICAgIGlmIChsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KQogICAgewogICAgICAgIGRlc3Ryb3kobGlua3MubWFuaWZlc3RhdGlvbi5saW5rcy5hYkJvdCk7CiAgICB9Cn0KCi8vcHJvZ3Jlc3MgYmFyIGZvciBtYW51YWwgcHVibGlzaGluZyBjb25maXJtYXRpb24KaWYgKGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpCnsKICAgIHByb2dyZXNzQnV0dG9uID0gYXdhaXQgbGlua3MuaW5wdXQuYWJQcm9ncmVzc0JhcihgdXBsb2FkaW5nICR7dGhhdC5hYn1gKTsKfQoKLy9hYiB2YXJpYWJsZXMKbGV0IGFiSUQgPSB0aGF0LmFiOwpsZXQga2V5ID0gdGhhdC5rZXk7CmxldCB0YXJnZXQgPSB0aGF0LnRhcmdldCA/IHRoYXQudGFyZ2V0IDogdGhhdC5ib3Q7CmxldCByZXR1cm5UeXBlID0gdGhhdC5yZXR1cm5UeXBlOwpsZXQgcHVibGljID0gdGhhdC5wdWJsaWMgPz8gY29uZmlnQm90LnRhZ3MucHVibGljOwpsZXQgc3RhdGUgPSB7fTsKbGV0IGZvcm1hdHRlZEZpbGUgPSB7fTsKCmNvbmZpZ0JvdC50YWdzLnB1YmxpYyA9IG51bGw7CgovL3RoaXMgbG9naWMgZm9ybWF0cyB0aGUgc3BlY2lmaWVkIGJvdHMgYW5kIHBhY2thZ2VzIHRoZW0gZm9yIHB1Ymxpc2hpbmcKaWYgKCFBcnJheS5pc0FycmF5KHRhcmdldCkgJiYgdGFyZ2V0ICE9IG51bGwgJiYgdGFyZ2V0ICE9IHVuZGVmaW5lZCkKewoKfQplbHNlIGlmICghdGFyZ2V0IHx8IHRhcmdldC5sZW5ndGggPCAxKQp7CiAgICB0YXJnZXQgPSBnZXRCb3RzKGJ5TW9kKHtzcGFjZTogInNoYXJlZCIsIGFiSWdub3JlOiBudWxsfSkpOwoKICAgIGlmICh0YXJnZXQubGVuZ3RoIDwgMSkKICAgIHsKICAgICAgICBvcy50b2FzdCgiTm8gYm90cyBmb3VuZCB0byBwdWJsaXNoIik7CgogICAgICAgIHNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgogICAgICAgIGxpbmtzLm1hbmlmZXN0YXRpb24uYWJDbGljaygpOwoKICAgICAgICByZXR1cm47CiAgICB9Cn0KCi8vdGhpcyBsb2dpYyBoYW5kbGVzIGdlbmVyYXRpbmcgYSBrZXkgZm9yIGVuY3J5cHRpb24gKG9wdGlvbmFsKQppZiAoY29uZmlnQm90LnRhZ3MuZW5jcnlwdGlvbikKewogICAgbGV0IGtleUNoZWNrOwoKICAgIGNvbmZpZ0JvdC50YWdzLmVuY3J5cHRpb24gPSBudWxsOwoKICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgIHR5cGU6ICdzZWNyZXQnLAogICAgICAgIHRpdGxlOiAnZW50ZXIgYSBzZWNyZXQga2V5JwogICAgfSk7CgogICAgaWYgKGtleSkKICAgIHsKICAgICAgICBrZXlDaGVjayA9IGF3YWl0IG9zLnNob3dJbnB1dCgiIiwgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdjb25maXJtIHNlY3JldCBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgaWYgKGtleSAhPSBrZXlDaGVjaykgewogICAgICAgIGlmICgha2V5Q2hlY2spCiAgICAgICAgewogICAgICAgICAgICBvcy50b2FzdCgibm8ga2V5IGVudGVyZWQiKTsKICAgICAgICB9CiAgICAgICAgZWxzZQogICAgICAgIHsKICAgICAgICAgICAgb3MudG9hc3QoImtleXMgZG8gbm90IG1hdGNoIik7CiAgICAgICAgfQoKICAgICAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgICAgICBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsKCiAgICAgICAgcmV0dXJuOwogICAgfQp9CgovL2Zvcm1hdHRpbmcgYm90cyBmb3IgZmlsZSBzdG9yYWdlCmlmIChBcnJheS5pc0FycmF5KHRhcmdldCkpIAp7CiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRhcmdldC5sZW5ndGg7IGkrKykgewogICAgICAgIGxldCBjdXJyZW50Qm90SUQgPSB0YXJnZXRbaV0uaWQ7CiAgICAgICAgbGV0IGN1cnJlbnRCb3QgPSB0YXJnZXRbaV07CiAgICAgICAgCiAgICAgICAgc3RhdGVbY3VycmVudEJvdElEXSA9IGN1cnJlbnRCb3Q7CiAgICB9Cn0KZWxzZSAKewogICAgc3RhdGVbdGFyZ2V0LmlkXSA9IHRhcmdldDsKfQoKLy9jaGVja3MgZm9yIHByZXZpb3VzIGVnZ3MgYW5kIHJldHVybnMgZGF0YSBmb3IgcHJldmlvdXNseSBwdWJsaXNoZWQgYWIncwpsZXQgZWdnQ2hlY2sgPSBhd2FpdCB0aGlzQm90LmFiUHJldmlvdXNFZ2dDaGVjayh7YWJJRDogYWJJRH0pOwoKLy9hZGQgeHAgYm90IGhlcmUKY29uc3QgeHBWZXJzaW9uQm90ID0ge307Cgp4cFZlcnNpb25Cb3Quc3BhY2UgPSAic2hhcmVkIjsKeHBWZXJzaW9uQm90LmlkID0gImFiWFBCb3QiOwp4cFZlcnNpb25Cb3QudGFncyA9IHt9Owp4cFZlcnNpb25Cb3QudGFncy5mb3JtID0gIm5vdGhpbmciOwp4cFZlcnNpb25Cb3QudGFncy5zeXN0ZW0gPSAiYWIucGF0dGVybi5hYlhQQm90IjsKeHBWZXJzaW9uQm90LnRhZ3MuYXV0aG9ySUQgPSBhdXRoQm90LmlkOwp4cFZlcnNpb25Cb3QudGFncy52ZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uOwp4cFZlcnNpb25Cb3QudGFncy54cCA9IGxpbmtzLmxlYXJuLnRhZ3MuYWJYUDsKeHBWZXJzaW9uQm90LnRhZ3Muc2lnbmF0dXJlID0gZWdnQ2hlY2suc2lnbmF0dXJlOwoKc3RhdGUuYWJYUEJvdCA9IHhwVmVyc2lvbkJvdDsKCi8vYWRkaXRpb25hbCBmaWxlIGRhdGEKZm9ybWF0dGVkRmlsZS52ZXJzaW9uID0gMTsKZm9ybWF0dGVkRmlsZS5zaWduYXR1cmUgPSBlZ2dDaGVjay5zaWduYXR1cmU7CmZvcm1hdHRlZEZpbGUuc3RhdGUgPSBzdGF0ZTsKCi8vYWN0dWFsIGVuY3J5cHRpb24gaWYgY2hvc2VuCmlmIChrZXkpIAp7CiAgICBmb3JtYXR0ZWRGaWxlID0gSlNPTi5zdHJpbmdpZnkoZm9ybWF0dGVkRmlsZSk7CgogICAgZm9ybWF0dGVkRmlsZSA9IGNyeXB0by5lbmNyeXB0KGtleSwgZm9ybWF0dGVkRmlsZSk7Cn0KCi8vcHVibGlzaCB0aGUgZmlsZQpsZXQgcHVibGlzaEZpbGUgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaEZpbGUoe2ZpbGU6IGZvcm1hdHRlZEZpbGUsIGZpbGVOYW1lOiBhYklEfSk7CgovL2dhdGhlciBhZGRpb25hbCBlZ2cgZGF0YQplZ2dDaGVjay5lZ2dEYXRhLmVnZ1ZlcnNpb25IaXN0b3J5LnB1c2gocHVibGlzaEZpbGUudXJsKTsKZWdnQ2hlY2suZWdnRGF0YS5tYXhWZXJzaW9uID0gZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CmVnZ0NoZWNrLmVnZ0RhdGEudGFyZ2V0VmVyc2lvbiA9IGVnZ0NoZWNrLmVnZ0RhdGEuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwoKLy9wdWJsaXNoIGVnZy9hYiByZWNvcmQKbGV0IHB1Ymxpc2hSZWNvcmQgPSBhd2FpdCB0aGlzQm90LmFiUHVibGlzaFJlY29yZCh7ZGF0YTogZWdnQ2hlY2suZWdnRGF0YSwgcmVjb3JkTmFtZTogYWJJRCwgcHVibGljOiBwdWJsaWN9KTsKbGV0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwoKLy9wdWJsaXNoaW5nIHNob3V0CnN1cGVyU2hvdXQoIm9uQUJQdWJsaXNoZWQiLCB7c3VjY2VzczogcHVibGlzaEZpbGUuc3VjY2VzcywgYWI6IGFiSUQsIGZpbGVBZGRyZXNzOiBwdWJsaXNoRmlsZS51cmx9KTsKCmNvbnN0IHN0dWRpb0xpbmsgPSBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA/PyBhdXRoQm90LmlkOwoKLy9zZW5kIGRhdGEgYW5kIGZvcm1hdCB1cmwgaWYgZGF0YSBzdWNjZXNzZnVsbHkgc2VudAppZiAocHVibGlzaFJlY29yZC5zdWNjZXNzKQp7CiAgICBjb25zdCBiaW9zID0iZnJlZSUyMGluc3QiOwoKICAgIHNldFRhZ01hc2sobGlua3MubGVhcm4sICJhYlhQIiwgIjAiLCAibG9jYWwiKTsKCiAgICBpZiAoa2V5ICYmIGNvbmZpZ0JvdC50YWdzLm1hbnVhbFB1Ymxpc2gpIAogICAgewogICAgICAgIG9zLnNldENsaXBib2FyZChzaXRlT3JpZ2luICsgIi8/cGF0dGVybj0iICsgYWJJRCArICIma2V5PSIgKyBrZXkgKyAiJnN0dWRpbz0iICsgc3R1ZGlvTGluayArICImYmlvcz0iICsgYmlvcyk7CiAgICAgICAgCiAgICAgICAgb3MudG9hc3QoImVuY3J5cHRlZCBkYXRhIHdpdGggYSBwdWJsaWMgaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZCIpOwogICAgfQogICAgZWxzZSBpZiAoY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCkKICAgIHsKICAgICAgICBvcy5zZXRDbGlwYm9hcmQoc2l0ZU9yaWdpbiArICIvP3BhdHRlcm49IiArIGFiSUQgKyAiJnN0dWRpbz0iICsgc3R1ZGlvTGluayArICImYmlvcz0iICsgYmlvcyk7CgogICAgICAgIG9zLnRvYXN0KCJwdWJsaWMgaW5zdCB1cmwgY29waWVkIHRvIGNsaXBib2FyZCIpOwogICAgfQoKICAgIHRyeSAKICAgIHsKICAgICAgICBhd2FpdCBhbmFseXRpY3MucmVjb3JkRXZlbnQoJ2FiX2VnZ19wdWJsaXNoJywgeyBhYjogYWJJRCwgdmVyc2lvbjogZWdnQ2hlY2suZWdnRGF0YS5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGggfSk7CiAgICB9CiAgICBjYXRjaCAoZSkgCiAgICB7CiAgICAgICAgY29uc29sZS5sb2coZSk7CiAgICB9Cn0KZWxzZQp7CiAgICBpZiAoIWNvbmZpZ0JvdC50YWdzLmFiU2lsZW50TW9kZSkKICAgIHsKICAgICAgICBvcy50b2FzdCgicHVibGlzaGluZyBmYWlsZWQsIHBsZWFzZSB0cnkgYWdhaW4iKTsKICAgIH0KCiAgICBhYi5sb2coImFiOiBwdWJsaXNoaW5nIGZhaWxlZCIpOwogICAgCiAgICBjb25zb2xlLmxvZyhwdWJsaXNoUmVjb3JkKTsKfQoKLy9jbGVhciBwcm9ncmVzcyBiYXIKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKfQoKY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IG51bGw7CgpyZXR1cm4gcHVibGlzaFJlY29yZDsnAPj5jNYHqCIIYWJJZ25vcmUCBAD4+YzWB7eyAQR0cnVlJwD4+YzWB6giCmFiRG93bmxvYWQCBAD4+YzWB7yyAdADQC8vZG93bmxvYWQgYm90cyAoZWl0aGVyIHNlbGVjdGVkIG9yIGFsbCBleHBlcmllbmNlKQpsZXQgZG93bmxvYWRCb3RzOwoKaWYgKGxpbmtzLnJlbWVtYmVyLmxpbmtzLmFiQm90Rm9jdXMpCnsKICAgIGRvd25sb2FkQm90cyA9IFtsaW5rcy5yZW1lbWJlci5saW5rcy5hYkJvdEZvY3VzXTsKCiAgICBhYi5sb2coImFiOiBkb3dubG9hZGluZyBib3QiKTsKfQplbHNlCnsKICAgIGRvd25sb2FkQm90cyA9IGdldEJvdHMoYnlNb2QoeyJhYklnbm9yZSI6IG51bGwsICJzcGFjZSI6ICJzaGFyZWQifSkpOwoKICAgIGFiLmxvZygiYWI6IGRvd25sb2FkaW5nIGluc3QiKTsKfQoKbGV0IGN1cnJlbnRJbnN0ID0gb3MuZ2V0Q3VycmVudEluc3QoKTsKCm9zLmRvd25sb2FkQm90cyhkb3dubG9hZEJvdHMsIGN1cnJlbnRJbnN0KTsKCnNob3V0KCJhYk1lbnVSZWZyZXNoIik7CgpsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsnAPj5jNYHqCINbWFuaWZlc3RhdGlvbgIEAPj5jNYHjbYBKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAPj5jNYHqCIEbWVudQIEAPj5jNYHtLYBKPCflJdiMzBjNmM1ZC1hNGY3LTQyNjYtYmEzOC0zOTNkYzk1ZTFlY2InAPj5jNYHqCISYWJQcmV2aW91c0VnZ0NoZWNrAgQA+PmM1gfbtgHZD0AvL3RoaXMgZnVuY3Rpb24gY2hlY2tzIGZvciBwcmV2aW91cyBlZ2dzIGF0IGEgc3BlY2lmaWVkIGFiLCByZXR1cm5pbmcgYW55IGRhdGEgdGhhdCBpdCBmaW5kcwpjb25zdCBhYklEID0gdGhhdC5hYklEOwoKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmxldCBlZ2dIaXN0b3J5OwpsZXQgZWdnSUQ7CmxldCB0YXJnZXRWZXJzaW9uTnVtOwpsZXQgbGFzdEhhc2g7CmxldCBtYXhWZXJzaW9uTnVtOwpsZXQgc3RhYmxlVmVyc2lvbjsKbGV0IGZlZWRiYWNrVmVyc2lvbjsKbGV0IHByZXZpb3VzWFA7CmxldCB1c2VyUmVjb3JkID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmxldCByZWNvcmRMb29rdXAgPSBhd2FpdCBvcy5nZXREYXRhKHVzZXJSZWNvcmQsIGFiSUQpLmNhdGNoKGUgPT4ge30pOwoKaWYgKHJlY29yZExvb2t1cC5zdWNjZXNzKSAKewogICAgZWdnSGlzdG9yeSA9IHJlY29yZExvb2t1cC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5OwogICAgZWdnSUQgPSByZWNvcmRMb29rdXAuZGF0YS5lZ2dJRDsKICAgIHByZXZpb3VzWFAgPSByZWNvcmRMb29rdXAuZGF0YS54cCA/PyAwOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IGVnZ0hpc3RvcnkubGVuZ3RoICsgMTsKICAgIGxhc3RIYXNoID0gZWdnSGlzdG9yeVt0YXJnZXRWZXJzaW9uTnVtIC0gMV07CiAgICBzdGFibGVWZXJzaW9uID0gcmVjb3JkTG9va3VwLmRhdGEuc3RhYmxlVmVyc2lvbjsKICAgIGZlZWRiYWNrVmVyc2lvbiA9IHJlY29yZExvb2t1cC5kYXRhLmZlZWRiYWNrVmVyc2lvbjsKICAgIG1heFZlcnNpb25OdW0gPSBlZ2dIaXN0b3J5Lmxlbmd0aCArIDE7Cn0gCmVsc2UgCnsKICAgIGVnZ0hpc3RvcnkgPSBbXTsKICAgIGVnZ0lEID0gdXVpZCgpOwogICAgdGFyZ2V0VmVyc2lvbk51bSA9IDE7CiAgICBsYXN0SGFzaCA9ICJub25lIjsKICAgIG1heFZlcnNpb25OdW0gPSAxOwogICAgcHJldmlvdXNYUCA9IDA7Cn0KCmlmIChjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9PSAiZmVlZGJhY2siKSAKewogICAgZmVlZGJhY2tWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9CmVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb25EZWZpbmVkID09ICJzdGFibGUiKQp7CiAgICBzdGFibGVWZXJzaW9uID0gZWdnSGlzdG9yeS5sZW5ndGggKyAxOwp9Cgpjb25maWdCb3QudGFncy52ZXJzaW9uRGVmaW5lZCA9IG51bGw7CgpsZXQgZWdnID0ge307CgplZ2cuZWdnVmVyc2lvbkhpc3RvcnkgPSBlZ2dIaXN0b3J5OwplZ2cuZWdnRm9ybWF0VmVyc2lvbiA9IGVnZ0lEOwplZ2cudGFyZ2V0VmVyc2lvbiA9IHRhcmdldFZlcnNpb25OdW07CmVnZy5tYXhWZXJzaW9uID0gbWF4VmVyc2lvbk51bTsKZWdnLmxhYmVsID0gInYiK3RhcmdldFZlcnNpb25OdW07CmVnZy5zdGFibGVWZXJzaW9uID0gc3RhYmxlVmVyc2lvbjsKZWdnLmZlZWRiYWNrVmVyc2lvbiA9IGZlZWRiYWNrVmVyc2lvbjsKZWdnLmFiSUQgPSBhYklEOwplZ2cueHAgPSBsaW5rcy5sZWFybi50YWdzLmFiWFA7CgpsZXQgc2lnbmF0dXJlID0ge307CmxldCBkYXRlID0gbmV3IERhdGUoKTsKbGV0IHRpbWUgPSBkYXRlLmdldFRpbWUoKTsKCnNpZ25hdHVyZS5wcmV2aW91c0hhc2ggPSBsYXN0SGFzaDsKc2lnbmF0dXJlLmFiVmVyc2lvbiA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb3JlVmVyc2lvbisiLiIrbGlua3MucmVtZW1iZXIudGFncy5hYkNvcmVJdGVyYXRpb247CnNpZ25hdHVyZS5lZ2dWZXJzaW9uID0gdGFncy5lZ2dVVUlEOwpzaWduYXR1cmUuZWdnVmVyc2lvbk51bSA9IHRhZ3Mub3ZvVmVyc2lvbjsKc2lnbmF0dXJlLnRpbWVTdGFtcCA9IHRpbWU7CnNpZ25hdHVyZS5jYXN1YWxPU1ZlcnNpb24gPSBbb3MudmVyc2lvbigpXTsKCnJldHVybiB7c2lnbmF0dXJlOiBzaWduYXR1cmUsIGVnZ0RhdGE6IGVnZ307KAD4+YzWB6giDGFiQm90VmVyc2lvbgF9qAInAPj5jNYHqCIPYWJCb3RNZW51QWN0aW9uAgQA+PmM1ge2xgFNQGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgovL3NldCB1cCB0aGUgcHVibGlzaCBtZW51CnRoaXNCb3Qub25TdG9yZU1lbnUoKTsnAPj5jNYHqCIOYWJCb3RNZW51TGFiZWwCBAD4+YzWB4THAQVzaGFyZScA+PmM1geoIg1hYkJvdE1lbnVJY29uAgQA+PmM1geKxwEJaW9zX3NoYXJlJwD4+YzWB6giEmFiQm90TWVudVNvcnRPcmRlcgIEAPj5jNYHlMcBATMnAPj5jNYHqCIFbGVhcm4CBAD4+YzWB5bHASjwn5SXNjY1N2I4NjUtZTk4My00NDAxLTlmYzktZjU0MThkMThhN2Y3JwD4+YzWB6giDWFiUHVibGlzaFVVQUICBAD4+YzWB73HAacPQGNvbmZpZ0JvdC50YWdzLnV1YWJTY2FuID0gbnVsbDsKCmxldCB1dWFiQ29uZmlnID0gYXdhaXQgbGlua3Muc2VhcmNoLm9uTG9va3VwQUJFZ2dzKHthYklEOiBjb25maWdCb3QudGFncy51dWFiLCByZXR1cm5UeXBlOiAiZGF0YSJ9KTsKCmxldCBwaW4gPSBhd2FpdCBvcy5zaG93SW5wdXQobnVsbCx7CiAgICB0aXRsZTogImVudGVyIHBpbiIsCiAgICB0eXBlOiAic2VjcmV0Igp9KTsKCmlmIChwaW4pCnsKICAgIGxldCBwaCA9IGNyeXB0by5zaGEyNTYocGluKS5zdWJzdHJpbmcoMCw0KTsKCiAgICBpZiAocGggPT0gY29uZmlnQm90LnRhZ3MucGgpCiAgICB7CiAgICAgICAgbGV0IHJlY29yZEtleTsKICAgICAgICBsZXQgZWdnRGF0YUNoZWNrOwogICAgICAgIGxldCBlZ2dEYXRhOwoKICAgICAgICBmb3IgKHRhZyBpbiB1dWFiQ29uZmlnLnN0YXRlKQogICAgICAgIHsKICAgICAgICAgICAgaWYgKHRhZykKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgcmVjb3JkS2V5ID0gdXVhYkNvbmZpZy5zdGF0ZVt0YWddLnRhZ3MucmVjb3JkS2V5OwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBpZiAodGhhdCkKICAgICAgICB7CiAgICAgICAgICAgIGVnZ0RhdGFDaGVjayA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCB0aGF0LnRhcmdldFJlY29yZCk7CgogICAgICAgICAgICBpZiAoZWdnRGF0YUNoZWNrLnN1Y2Nlc3MpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGlmIChlZ2dEYXRhQ2hlY2suZGF0YS5lZ2dzKQogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRyeQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgZWdnRGF0YSA9IEpTT04ucGFyc2UoZWdnRGF0YUNoZWNrLmRhdGEuZWdncyk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZWdnRGF0YS5sZW5ndGggPj0gMTIpCiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9zLnRvYXN0KCJwcmFjdGljZSBwZXJtaXQgZnVsbCIpOwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNob3V0KCJhYlJlZnJlc2giKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY2F0Y2gKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCJlZ2cgZGF0YSBub3QgcmVhZGFibGUiKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGVnZ0RhdGEgPSBbXTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9IAogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICBsaW5rcy5yZW1lbWJlci5tYXNrcy5hYlJlY29yZEtleSA9IHJlY29yZEtleTsKCiAgICAgICAgY29uZmlnQm90LnRhZ3MubWFudWFsUHVibGlzaCA9IHRydWU7CgogICAgICAgIHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiBjb25maWdCb3QudGFncy5hYiwga2V5OiBjb25maWdCb3QudGFncy5rZXl9KTsKCiAgICAgICAgZWdnRGF0YS5wdXNoKGNvbmZpZ0JvdC50YWdzLmFiKTsKCiAgICAgICAgZWdnRGF0YVRvUHVibGlzaCA9IHtlZ2dzOiBKU09OLnN0cmluZ2lmeShlZ2dEYXRhKX07CgogICAgICAgIGF3YWl0IG9zLnJlY29yZERhdGEocmVjb3JkS2V5LCB0aGF0LnRhcmdldFJlY29yZCwgZWdnRGF0YVRvUHVibGlzaCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgYXdhaXQgb3MudG9hc3QoInBpbiBkb2VzIG5vdCBtYXRjaCIsIDIpOwoKICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CiAgICB9Cn0KZWxzZQp7CiAgICBhd2FpdCBvcy50b2FzdCgibm8gcGluIGdpdmVuIiwgMik7CgogICAgc2hvdXQoImFiUmVmcmVzaCIpOwoKICAgIHJldHVybgp9JwD4+YzWB6giC2FiUVJQdWJsaXNoAgQA+PmM1gfl1gHvBEBjb25maWdCb3QudGFncy5wdWJsaXNoU2NhbiA9IG51bGw7CgpsZXQgc2Nhbm5lZFVSTDsKCnRyeSAKewogICAgc2Nhbm5lZFVSTCA9IG5ldyBVUkwodGhhdCk7Cn0KY2F0Y2ggKGUpIHsKICAgIHNob3V0KCJhYlB1Ymxpc2hBQiIsIHthYjogdGhhdH0pOwoKICAgIHRoaXNCb3QuYWJQdWJsaXNoQUIoe2FiOiB0aGF0fSk7CgogICAgcmV0dXJuOwp9CgppZiAoc2Nhbm5lZFVSTC5zZWFyY2hQYXJhbXMuZ2V0KCJwaCIpKSAKewogICAgbGV0IHRhcmdldFJlY29yZCA9IHNjYW5uZWRVUkwuc2VhcmNoUGFyYW1zLmdldCgiaW5zdCIpOwoKICAgIGNvbmZpZ0JvdC50YWdzLnV1YWIgPSBzY2FubmVkVVJMLnNlYXJjaFBhcmFtcy5nZXQoImFiIik7CiAgICBjb25maWdCb3QudGFncy5waCA9IHNjYW5uZWRVUkwuc2VhcmNoUGFyYW1zLmdldCgicGgiKTsKICAgIGNvbmZpZ0JvdC50YWdzLmFiID0gdXVpZCgpOwogICAgY29uZmlnQm90LnRhZ3Mua2V5ID0gc2Nhbm5lZFVSTC5zZWFyY2hQYXJhbXMuZ2V0KCJwaCIpOwoKICAgIHRoaXNCb3QuYWJQdWJsaXNoVVVBQih7dGFyZ2V0UmVjb3JkOiB0YXJnZXRSZWNvcmR9KTsKfQplbHNlIAp7CiAgICBvcy50b2FzdCgidW5zdXBwb3J0ZWQgdXJsIGZvcm1hdCIpOwp9JwD4+YzWB6giBnNlYXJjaAIEAPj5jNYH1dsBKPCflJdkODM3MTQ0NC05MTU4LTQ0MzYtOGZjNy04NGNjOTFiN2Y1MjUnAPj5jNYHqCIHYWJTaGVsbAIEAPj5jNYH/NsBBHRydWUnAPj5jNYHqCIMc3R1ZGlvU2VsZWN0AgQA+PmM1geB3AGhCkBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSAiYWJNZW51IjsKCmxpbmtzLm1lbnUubWFza3Mub25HcmlkQ2xpY2sgPSAiQCBzaG91dCgnYWJNZW51UmVmcmVzaCcpOyBsaW5rcy5tYW5pZmVzdGF0aW9uLmFiQ2xpY2soKTsiOwoKY29uc3Qgc3R1ZGlvcyA9IHRoYXQuc3R1ZGlvczsKY29uc3QgdGFyZ2V0U3R1ZGlvID0gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPyBjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbyA6IGF1dGhCb3QuaWQ7CmNvbnN0IG1lbnVCdXR0b24gPSB7fTsKCm1lbnVCdXR0b24uYWJNZW51ID0gdHJ1ZTsKbWVudUJ1dHRvbi5hYk1lbnVTb3J0T3JkZXIgPSAwOwptZW51QnV0dG9uLmFiTWVudVJlZnJlc2ggPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ubGFiZWwgPSAicGxheWVyIHN0dWRpbyI7Cm1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYXV0aEJvdC5pZCA/ICJyYWRpb19idXR0b25fY2hlY2tlZCIgOiAicmFkaW9fYnV0dG9uX3VuY2hlY2tlZCI7Cm1lbnVCdXR0b24uY29sb3IgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiQmFzZVN0cm9rZUNvbG9yOwptZW51QnV0dG9uLm1hbmFnZXIgPSAi8J+UlyIgKyB0aGlzQm90LmlkOwptZW51QnV0dG9uLnN0dWRpb0lEID0gYXV0aEJvdC5pZDsKbWVudUJ1dHRvbi5vbkNsaWNrID0gYEAgY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSB0YWdzLnN0dWRpb0lEOwoKbGlua3MubWFuYWdlci5vblN0b3JlTWVudSgpO2A7CgpsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbihtZW51QnV0dG9uKTsKCmZvciAobGV0IGkgPSAwOyBpIDwgc3R1ZGlvcy5sZW5ndGg7IGkrKykKewogICAgbGV0IGFjdGl2ZVN0dWRpbyA9IHN0dWRpb3NbaV07CiAgICBjb25zb2xlLmxvZygiQUNUSVZFIiwgdGFyZ2V0U3R1ZGlvICsgIiwgIiArIGFjdGl2ZVN0dWRpby5zdHVkaW9JZCkKICAgIG1lbnVCdXR0b24uZm9ybUFkZHJlc3MgPSB0YXJnZXRTdHVkaW8gPT0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkID8gInJhZGlvX2J1dHRvbl9jaGVja2VkIiA6ICJyYWRpb19idXR0b25fdW5jaGVja2VkIjsKICAgIG1lbnVCdXR0b24ubGFiZWwgPSBhY3RpdmVTdHVkaW8uZGlzcGxheU5hbWU7CiAgICBtZW51QnV0dG9uLnN0dWRpb0lEID0gYWN0aXZlU3R1ZGlvLnN0dWRpb0lkOwoKICAgIGxpbmtzLm1lbnUuYWJDcmVhdGVNZW51QnV0dG9uKG1lbnVCdXR0b24pOwp9JwD4+YzWB6giDmFiUHVibGlzaEFza0lEAgQA+PmM1geh5gH0BEBsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGBwdWJsaXNoaW5nICR7dGhhdC5hc2tJRH1gKTsKCmF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7Cgpjb25zdCBwYXR0ZXJuSUQgPSB0aGF0LnBhdHRlcm5JRDsKY29uc3Qgc3R1ZGlvSUQgPSB0aGF0LnN0dWRpb0lEID8gdGhhdC5zdHVkaW9JRCA6IGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID8gY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgOiBhdXRoQm90LmlkOwpjb25zdCBhc2tJRCA9ICJhc2tfIiArIHRoYXQuYXNrSUQucmVwbGFjZUFsbCgiLSIsICIiKTsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmNvbnN0IHB1Ymxpc2hBc2sgPSBhd2FpdCBvcy5yZWNvcmREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFza0lELCB7cGF0dGVybklEOiBwYXR0ZXJuSUQsIHN0dWRpb0lEOiBzdHVkaW9JRH0sIHtlbmRwb2ludDogZW5kcG9pbnQsIHVwZGF0ZVBvbGljeTogW2F1dGhCb3QuaWRdfSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gcHVibGlzaEFzazsnAPj5jNYHqCIFaW5wdXQCBAD4+YzWB5brASjwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwD4+YzWB6giC2FiRW1iZWRMaW5rAgQA+PmM1ge96wGkA0Bjb25zdCBhYiA9IHRoYXQgPyB0cnVlIDogZmFsc2U7CmNvbnN0IGVtYmVkTGluayA9IGFiID8gImFiPSIgKyB0aGF0IDogImluc3Q9IiArIGNvbmZpZ0JvdC50YWdzLmluc3Q7CmNvbnN0IHNpdGVPcmlnaW4gPSBuZXcgVVJMKGNvbmZpZ0JvdC50YWdzLnVybCkub3JpZ2luOwpjb25zdCBlbWJlZFRleHQgPSBgPCFET0NUWVBFIGh0bWw+CsKgwqDCoMKgPGh0bWw+CsKgwqDCoMKgwqDCoMKgwqA8aGVhZD48L2hlYWQ+CsKgwqDCoMKgwqDCoMKgwqA8Ym9keT4KwqDCoMKgwqDCoMKgwqDCoMKgwqDCoMKgPGlmcmFtZSBzcmM9IiR7c2l0ZU9yaWdpbiArICIvPyIgKyBlbWJlZExpbmt9IiB3aWR0aD0iMTAwJSIgaGVpZ2h0PSI0MDAiIC8+CsKgwqDCoMKgwqDCoMKgwqA8L2JvZHk+CsKgwqDCoMKgPC9odG1sPmA7CgpyZXR1cm4gZW1iZWRUZXh0OycA+PmM1geoIg9hYlBhdHRlcm5VcGRhdGUCBAD4+YzWB7buAeYEQC8vc2hvdXQoImFiUGF0dGVyblVwZGF0ZSIsIHthYklEOiBhYklELCBzdHVkaW86c3R1ZGlvPywgYm90czogYm90cz99KTsKYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCmlmICghYXV0aEJvdCkKewogICAgcmV0dXJuOwp9Cgpjb25zdCBhYklEID0gdGhhdC5hYklEOwpjb25zdCBzdHVkaW8gPSB0aGF0LnN0dWRpbyA/IHRoYXQuc3R1ZGlvIDogY29uZmlnQm90LnRhZ3Muc3R1ZGlvID8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvIDogYXV0aEJvdC5pZDsKY29uc3QgYWJNYW5pZmVzdCA9IGdldEJvdChieU1vZCh7YWJBcnRpZmFjdDogdHJ1ZSwgb3JpZ2luX2FiOiBhYklEfSkpOwoKaWYgKCFhYk1hbmlmZXN0KQp7CiAgICBzaG91dCgib25Mb29rdXBBQkVnZ3MiLCB7YWJJRDogYWJJRCwgcmVjb3JkS2V5OiBzdHVkaW8sIGF1dG9IYXRjaDogdHJ1ZX0pOwoKICAgIHJldHVybjsKfQoKY29uZmlnQm90LnRhZ3Muc2VsZWN0ZWRfc3R1ZGlvSUQgPSBzdHVkaW87Cgpjb25zdCBhYkJvdHMgPSB0aGF0LmJvdHMgPz8gZ2V0Qm90cygiYWJJRE9yaWdpbiIsIGFiSUQpOwoKYXdhaXQgdGhpc0JvdC5hYlB1Ymxpc2hBQih7YWI6IGFiSUQsIHRhcmdldDogYWJCb3RzLCBwdWJsaWM6IHRydWV9KTsnAQRib3RzJGQ4MzcxNDQ0LTkxNTgtNDQzNi04ZmM3LTg0Y2M5MWI3ZjUyNQEnAPj5jNYHnfMBBnN5c3RlbQIEAPj5jNYHnvMBD2FiLnNoZWxsLnNlYXJjaCcA+PmM1ged8wEEZm9ybQIEAPj5jNYHrvMBB25vdGhpbmcnAPj5jNYHnfMBDmFiUmV0cmlldmVGaWxlAgQA+PmM1ge28wGCAUAvL3B1bGwgZG93biBmaWxlIGRhdGEKaWYgKCF0aGF0LnVybCkKewogICAgcmV0dXJuICJubyBmaWxlIHVybCBzdXBwbGllZCI7Cn0KCmxldCBkYXRhID0gYXdhaXQgb3MuZ2V0RmlsZSh0aGF0LnVybCk7CgpyZXR1cm4gZGF0YTsnAPj5jNYHnfMBEGFiUmV0cmlldmVSZWNvcmQCBAD4+YzWB7n0AewEQC8vcmV0cmlldmUgc3BlY2lmaWVkIHJlY29yZApsZXQgcmVjb3JkTmFtZSA9IHRoYXQucmVjb3JkTmFtZTsKCmxldCByZWNvcmRLZXkgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiUmVjb3JkS2V5OwoKaWYgKHRoYXQucmVjb3JkS2V5KQp7CiAgICByZWNvcmRLZXkgPSB0aGF0LnJlY29yZEtleTsKfQplbHNlIGlmIChhdXRoQm90KQp7CiAgICBpZiAoYXV0aEJvdC5pZCA9PSBjb25maWdCb3QudGFncy5zdHVkaW8pCiAgICB7CiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKCiAgICAgICAgYXdhaXQgb3MuZ3JhbnRJbnN0QWRtaW5QZXJtaXNzaW9uKHJlY29yZEtleSk7CiAgICB9Cn0KCmxldCByZWNvcmRFbmRwb2ludCA9IHRoYXQucmVjb3JkRW5kcG9pbnQgPyB0aGF0LnJlY29yZEVuZHBvaW50IDogbGlua3MucmVtZW1iZXIudGFncy5hYkVuZHBvaW50OwoKaWYgKCFyZWNvcmROYW1lKQp7CiAgICByZXR1cm4gIm5vIHJlY29yZCBuYW1lIHN1cHBsaWVkIjsKfQoKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCByZWNvcmROYW1lLCByZWNvcmRFbmRwb2ludCk7CgovL0FERCBhZGRpdGlvbmFsIGVycm9yIGhhbmRsaW5nPwoKcmV0dXJuIGdldFJlY29yZDsnAPj5jNYHnfMBCHJlbWVtYmVyAgQA+PmM1gem+QEo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA+PmM1ged8wENbWFuaWZlc3RhdGlvbgIEAPj5jNYHzfkBKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAPj5jNYHnfMBDm9uTG9va3VwQUJFZ2dzAgQA+PmM1gf0+QGYIUAvL3Nob3V0KCJvbkxvb2t1cEFCRWdncyIsIHthYklEOiBhYklELCBrZXk6IGtleSwgYXV0b0hhdGNoOiBib29sZWFuLCByZXR1cm5UeXBlOiBkYXRhL251bGx9KTsKYWIubG9nKCJhYjogbG9hZGluZyAiICsgdGhhdC5hYklEKTsKCi8vY2xlYXIgYWItMQppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgbGlua3MubWFuaWZlc3RhdGlvbi5hYkNsaWNrKCk7Cn0KCmxldCBwcm9ncmVzc0J1dHRvbiA9IGF3YWl0IGxpbmtzLmlucHV0LmFiUHJvZ3Jlc3NCYXIoYGxvYWRpbmcgJHt0aGF0LmFiSUR9YCk7CgovL2NvbnN0YW50cyBpbiByZWdhcmRzIHRvIHRoZSBhYiB0byBiZSBsb29rZWQgdXAKY29uc3QgYWJJRCA9IHRoYXQuYWJJRDsKY29uc3QgaW5pdGlhbEJvb3QgPSB0aGF0LmluaXRpYWxCb290Owpjb25zdCBhdXRvSGF0Y2ggPSB0aGF0LmF1dG9IYXRjaDsKCi8vcmVjb3JkS2V5IGlzIHZhcmlhYmxlIGRlcGVuZGluZyBvbiBpZiBwdWJsaWMKbGV0IHJlY29yZEtleSA9IHRoYXQucmVjb3JkS2V5ID8/IGNvbmZpZ0JvdC50YWdzLnN0dWRpbzsKbGV0IHBvc3NpYmxlQXV0aCA9IGF1dGhCb3QgPyBhdXRoQm90IDogdHJ1ZTsKbGV0IGdldFJlY29yZCA9IGF3YWl0IG9zLmdldERhdGEocmVjb3JkS2V5LCBhYklEKTsKCi8vdmFyaWFibGVzIGZvciBlZ2cvYWIgaGF0Y2hpbmcKbGV0IHJldHVyblR5cGUgPSB0aGF0LnJldHVyblR5cGU7CmxldCBrZXkgPSB0aGF0LmtleTsKbGV0IG5ld0VnZzsKCi8vdGhpcyBsb2dpYyBoYW5kbGVzIHRoZSByZXRyaWV2ZWQgZGF0YSwgc2VhcmNoZXMgYWdhaW4gaWYgbm9uZSBjYW1lIHRocm91Z2gKaWYgKCFnZXRSZWNvcmQuc3VjY2VzcyAmJiBwb3NzaWJsZUF1dGguaWQgPT0gcmVjb3JkS2V5ICYmIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXkgJiYgZ2V0UmVjb3JkLmVycm9yQ29kZSAhPSAibm90X2F1dGhvcml6ZWQiKQp7CiAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIGFiSUQpOwp9CmVsc2UgaWYgKCFnZXRSZWNvcmQuc3VjY2VzcykKewogICAgaWYgKCFyZWNvcmRLZXkpCiAgICB7CiAgICAgICAgYXdhaXQgb3MucmVxdWVzdEF1dGhCb3QoKTsKCiAgICAgICAgcmVjb3JkS2V5ID0gYXV0aEJvdC5pZDsKICAgIH0KCiAgICBhd2FpdCBvcy5ncmFudEluc3RBZG1pblBlcm1pc3Npb24ocmVjb3JkS2V5KTsKCiAgICBnZXRSZWNvcmQgPSBhd2FpdCBvcy5nZXREYXRhKHJlY29yZEtleSwgYWJJRCk7Cn0KCmlmICghZ2V0UmVjb3JkLnN1Y2Nlc3MpCnsKICAgIG9zLnRvYXN0KGBubyBkYXRhIGZvdW5kIGluICR7YWJJRH1gKTsKCiAgICBzaG91dCgiYWJNZW51UmVmcmVzaCIpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikKICAgIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KCiAgICByZXR1cm4ge3N1Y2Nlc3M6IGZhbHNlfTsKfQplbHNlCnsKICAgIC8vcGFja2FnZSB0aGUgcmVjb3JkIGRhdGEKICAgIG5ld0VnZyA9IGdldFJlY29yZC5kYXRhOwp9CgphYi5sb2coImFiOiAiICsgdGhhdC5hYklEICsgIiBsb2FkZWQsIHZlcnNpb24gIiArIGdldFJlY29yZC5kYXRhLnRhcmdldFZlcnNpb24gKyAiIG9mICIgKyBnZXRSZWNvcmQuZGF0YS5tYXhWZXJzaW9uKTsKCi8vdGhpcyBsb2dpYyBwYXJzZXMgdGhlIGRhdGEgZGVwZW5kYW50IG9uIGhvdyBpdCB3YXMgYWNjZXNzZWQvZ2FpbmVkCmlmIChyZXR1cm5UeXBlID09ICJkYXRhIiAmJiBnZXRSZWNvcmQuc3VjY2VzcykKewogICAgbGV0IHZlcnNpb24gPSBnZXRSZWNvcmQuZGF0YS50YXJnZXRWZXJzaW9uIC0gMTsKCiAgICBpZiAodGhhdC5hYlZlcnNpb24pCiAgICB7CiAgICAgICAgaWYgKCFpc05hTih0aGF0LmFiVmVyc2lvbikpCiAgICAgICAgewogICAgICAgICAgICB2ZXJzaW9uID0gdGhhdC5hYlZlcnNpb24gLSAxOwogICAgICAgIH0KICAgIH0KCiAgICBsZXQgZWdnRGF0YVVSTCA9IGdldFJlY29yZC5kYXRhLmVnZ1ZlcnNpb25IaXN0b3J5W3ZlcnNpb25dOwogICAgbGV0IHJldHVybkRhdGEgPSBhd2FpdCBvcy5nZXRGaWxlKGVnZ0RhdGFVUkwpOwoKICAgIGlmIChwcm9ncmVzc0J1dHRvbikKICAgIHsKICAgICAgICBkZXN0cm95KHByb2dyZXNzQnV0dG9uKTsKICAgIH0KCiAgICByZXR1cm4gcmV0dXJuRGF0YTsKfQplbHNlIGlmIChyZXR1cm5UeXBlID09ICJkYXRhIikKewogICAgbGV0IHZlcnNpb25BcnJheSA9IEpTT04ucGFyc2UobmV3RWdnLmVnZ1ZlcnNpb25IaXN0b3J5KTsKICAgIGxldCBmaWxlVVVJRCA9IHZlcnNpb25BcnJheVtuZXdFZ2cubWF4VmVyc2lvbiAtIDFdOwogICAgbGV0IGZpbGVuYW1laGFzaExUTSA9IGNyeXB0by5zaGEyNTYoZmlsZVVVSUQpOwogICAgbGV0IGZpbGV1cmxoYXNoTFRNID0gImF1eF8iICsgZmlsZW5hbWVoYXNoTFRNICsgJy5hdXgnOwogICAgbGV0IHRhcmdldExUTVVSTCA9ICJodHRwczovL2J1aWxkZXItbHRtLWZpbGVzLnMzLmFtYXpvbmF3cy5jb20vIiArIGZpbGV1cmxoYXNoTFRNOwogICAgbGV0IG8gPSB7fTsKICAgIG8ubWV0aG9kID0gIkdFVCI7CiAgICBvLnVybCA9IHRhcmdldExUTVVSTDsKCiAgICBmaWxlR2V0ID0gYXdhaXQgd2ViaG9vayhvKTsKCiAgICBpZiAocHJvZ3Jlc3NCdXR0b24pCiAgICB7CiAgICAgICAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7CiAgICB9CgogICAgaWYgKGZpbGVHZXQuc3RhdHVzICE9IDIwMCkKICAgIHsKICAgICAgICBvcy50b2FzdCgibm8gZmlsZSBmb3VuZCIpOwoKICAgICAgICBzaG91dCgiYWJSZWZyZXNoIik7CgogICAgICAgIHJldHVybiB7c3VjY2VzczogZmFsc2V9OwogICAgfQogICAgZWxzZQogICAgewogICAgICAgIGZpbGVHZXQgPSBmaWxlR2V0LmRhdGE7CiAgICB9CgogICAgcmV0dXJuIGZpbGVHZXQ7Cn0KCi8vYWIgc3BlY2lmaWMgdmFyaWFibGVzIGZvciB1bmRlcnN0YW5kaW5nIGlmIGEgcG9zaXRpb24gaXMgc3BlY2lmaWVkCmxldCBjdXJyZW50RGltOwpsZXQgc3BhY2VNb2Q7CmxldCBkaW1lbnNpb25YOwpsZXQgZGltZW5zaW9uWTsKbGV0IGRpbU1vZDsKCi8vaGFuZGxlIGRpbWVuc2lvbiBpZGVudGlmaWNhdGlvbgppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpCiAgICB7CiAgICAgICAgY29uc3QgYWJCb3QgPSBsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90OwoKICAgICAgICBjdXJyZW50RGltID0gYWJCb3QudGFncy5kaW1lbnNpb247CiAgICB9Cn0KZWxzZQp7CiAgICBjdXJyZW50RGltID0gb3MuZ2V0Q3VycmVudERpbWVuc2lvbigpOwp9CgovL2NoZWNrcyBmb3IgZ3JpZCBmb2N1cwppZiAoIWxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJHcmlkRm9jdXMpIAp7CiAgICBkaW1lbnNpb25YID0gbnVsbDsKICAgIGRpbWVuc2lvblkgPSBudWxsOwp9CmVsc2UKewogICAgbGV0IGhhdGNoUG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiR3JpZEZvY3VzOwoKICAgIGN1cnJlbnREaW0gPSBoYXRjaFBvaW50LmRpbWVuc2lvbjsKICAgIGRpbWVuc2lvblggPSBoYXRjaFBvaW50LnBvc2l0aW9uLng7CiAgICBkaW1lbnNpb25ZID0gaGF0Y2hQb2ludC5wb3NpdGlvbi55OwogICAgc3BhY2VNb2QgPSB7c3BhY2U6ICJzaGFyZWQifTsKfQoKLy90aGlzIGxvZ2ljIGhhbmRsZXMgbG9naWMgYXJvdW5kIGF1dG9IYXRjaCB2cyBtYW51YWwgaGF0Y2hpbmcKaWYgKCFhdXRvSGF0Y2ggJiYgY29uZmlnQm90LnRhZ3MucGF0dGVybiA9PSBudWxsKQp7CiAgICBkaW1Nb2QgPSB7W2N1cnJlbnREaW1dOiB0cnVlLCBbY3VycmVudERpbSsiWCJdOiBkaW1lbnNpb25YLCBbY3VycmVudERpbSsiWSJdOiBkaW1lbnNpb25ZLCBkaW1lbnNpb246IGN1cnJlbnREaW19Owp9CmVsc2UKewogICAgaWYgKGNvbmZpZ0JvdC50YWdzLmtleSAmJiAhdGhhdC5rZXkpCiAgICB7CiAgICAgICAga2V5ID0gY29uZmlnQm90LnRhZ3Mua2V5CiAgICB9CgogICAgZGltTW9kID0ge2F1dG9IYXRjaDogdHJ1ZSwga2V5OiBrZXl9Owp9CgovL2NhbGwgZm9yIG92byB3aXRoIGluZm9ybWF0aW9uIHByb3ZpZGVkCnRoaXNCb3QubWFuaWZlc3RPdm8oe2FiSUQ6IGFiSUQsIGRpbU1vZDogZGltTW9kLCBzcGFjZU1vZDogc3BhY2VNb2QsIGVnZ0RhdGE6IG5ld0VnZywgaW5pdGlhbEJvb3Q6IGluaXRpYWxCb290fSk7CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4ge3N1Y2Nlc3M6IHRydWV9OycA+PmM1ged8wELbWFuaWZlc3RPdm8CBAD4+YzWB42bApoLQC8vZWdnIHZpc3VhbGl6YXRpb24Kc2hvdXQoImFiTWVudVJlc2V0Iik7CgppZiAobGlua3MubWFuaWZlc3RhdGlvbikKewogICAgaWYgKGxpbmtzLm1hbmlmZXN0YXRpb24ubGlua3MuYWJCb3QpCiAgICB7CiAgICAgICAgZGVzdHJveShsaW5rcy5tYW5pZmVzdGF0aW9uLmxpbmtzLmFiQm90KTsKICAgIH0KfQoKaWYgKGxpbmtzLm92b0JvdCkKewogICAgZGVzdHJveShsaW5rcy5vdm9Cb3QpOwp9CgpsZXQgc3BhY2VNb2QgPSB0aGF0LnNwYWNlTW9kOwpsZXQgZGltTW9kID0gdGhhdC5kaW1Nb2Q7CmxldCBlZ2dEYXRhID0gdGhhdC5lZ2dEYXRhOwpsZXQgZWdnTW9kID0ge307CgplZ2dNb2Quc3BhY2UgPSAidGVtcExvY2FsIjsKZWdnTW9kLmluaXRpYWxUaW1lciA9IHRydWU7CmVnZ01vZC5hYklEID0gdGhhdC5hYklEOwplZ2dNb2QuaW5pdGlhbEJvb3QgPSB0aGF0LmluaXRpYWxCb290OwplZ2dNb2QubWFuYWdlciA9ICLwn5SXIiArIHRoaXNCb3QuaWQ7CmVnZ01vZC5vbkNsaWNrID0gYEAgbGlua3MubWFuYWdlci5pbnRlcmFjdE92bygpO2A7CmVnZ01vZC5vbkNyZWF0ZSA9IGBAIGlmICh0YWdzLmF1dG9IYXRjaCkKewogICAgbGlua3MubWFuYWdlci5oYXRjaE92byh0aGlzQm90KTsKfQplbHNlCnsKICAgIHRhZ3MucHJvZ3Jlc3NCYXIgPSAwOyAKICAgIAogICAgY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IHRhZ3MubWF4VmVyc2lvbjsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKfWA7CmVnZ01vZC5mb3JtID0gImVnZyI7CmVnZ01vZC5wcm9ncmVzc0JhckNvbG9yID0gIiNCRjVFNjYiOwplZ2dNb2QucHJvZ3Jlc3NCYXJCYWNrZ3JvdW5kQ29sb3IgPSAiIzU5Mjk4OSI7CmVnZ01vZC5sYWJlbFNpemUgPSAwLjU7CmVnZ01vZC5sYWJlbENvbG9yID0gIiM0MDQwNDAiOwplZ2dNb2Qub25Qb2ludGVyRW50ZXIgPSAiQCBvcy50b2FzdCh0YWdzLmFiSUQgKyAnIHYnK3RhZ3MudGFyZ2V0VmVyc2lvbik7IjsKZWdnTW9kLmxhYmVsUG9zaXRpb24gPSAiZnJvbnQiOwplZ2dNb2Qub3JpZW50YXRpb25Nb2RlID0gImJpbGxib2FyZEZyb250IjsKZWdnTW9kLm9uRGVzdHJveSA9IGBAIGxpbmtzLm1hbmFnZXIubWFza3Mub3ZvQm90ID0gbnVsbDtgOwplZ2dNb2QuZWdnVGltZXIgPSBgQCBpZiAodGFncy5wcm9ncmVzc0JhciA8IDEpIAp7CiAgICB0YWdzLnByb2dyZXNzQmFyICs9IDAuMTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHt3aGlzcGVyKHRoaXNCb3QsICJlZ2dUaW1lciIpO30sIDc1KTsKfQplbHNlCnsKICAgIHRoaXNCb3Qub25DbGljaygpOwogICAgCiAgICB0YWdzLnByb2dyZXNzQmFyID0gbnVsbDsKfWA7CgpsZXQgb3ZvID0gY3JlYXRlKGVnZ0RhdGEsIGVnZ01vZCwgZGltTW9kLCBzcGFjZU1vZCk7CgptYXNrcy5vdm9Cb3QgPSAi8J+UlyIgKyBvdm8uaWQ7JwD4+YzWB53zAQlvbktleURvd24CBAD4+YzWB6SmAtoFQC8vaGlkZGVuIHZlcnNpb24gYnV0dG9uIGZvciBoYXRjaCBtZW51CmlmICghbGlua3Mub3ZvQm90IHx8IGNvbmZpZ0JvdC50YWdzLm1lbnVQb3J0YWwgIT0gIm92byIpCnsKICAgIHJldHVybjsKfQoKaWYgKHRoYXQua2V5cyA9PSAiU2hpZnQiKQp7CiAgICBsZXQgdmVyc2lvbkJ1dHRvbiA9IHt9OwoKICAgIHZlcnNpb25CdXR0b24ub3ZvID0gdHJ1ZTsKICAgIHZlcnNpb25CdXR0b24ub3ZvU29ydE9yZGVyID0gLTE7CiAgICB2ZXJzaW9uQnV0dG9uLm1heFZlcnNpb24gPSBsaW5rcy5vdm9Cb3QudGFncy5tYXhWZXJzaW9uOwogICAgdmVyc2lvbkJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKICAgIHZlcnNpb25CdXR0b24ubGFiZWwgPSAiY2hhbmdlIGVnZyB2ZXJzaW9uIjsKICAgIHZlcnNpb25CdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKICAgIHZlcnNpb25CdXR0b24ub3ZvTWVudVJlc2V0ID0gIkAgZGVzdHJveSh0aGlzQm90KTsiOwogICAgdmVyc2lvbkJ1dHRvbi5jb2xvciA9ICIjRkZGRkZGIjsKICAgIHZlcnNpb25CdXR0b24ub25LZXlVcCA9ICJAIGlmKHRoYXQua2V5cyA9PSAnU2hpZnQnKXtkZXN0cm95KHRoaXNCb3QpfTsiOwogICAgdmVyc2lvbkJ1dHRvbi5vbkNsaWNrID0gIkAgbGlua3MubWFuYWdlci5jaGFuZ2VPdm9WZXJzaW9uKCk7IjsKCiAgICBsaW5rcy5tZW51LmFiQ3JlYXRlTWVudUJ1dHRvbih2ZXJzaW9uQnV0dG9uKTsKfScA+PmM1ged8wEIaGF0Y2hPdm8CBAD4+YzWB/2rApMTQC8vbG9naWMgZm9yIGhhdGNoaW5nIG9mIGFuIGFiCnNob3V0KCdvdm9NZW51UmVzZXQnKTsKCi8vZGF0YSBpbiByZWdhcmRzIHRvIHdoYXQgYWIgaXMgZ29pbmcgdG8gYmUgaGF0Y2hlZApjb25zdCBvdm8gPSB0aGF0OwoKLy9oYXRjaCBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGluaXRpYWxCb290ID0gb3ZvLnRhZ3MuaW5pdGlhbEJvb3Q7CmxldCB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiA/PyBvdm8udGFncy50YXJnZXRWZXJzaW9uOwoKaWYgKChjb25maWdCb3QudGFncy5hYlZlcnNpb24gfHwgY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb24pICYmIChvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm4gfHwgb3ZvLnRhZ3MuYWJJRCA9PSBjb25maWdCb3QudGFncy5hYikpCnsKICAgIHRhcmdldFZlcnNpb24gPSBjb25maWdCb3QudGFncy5hYlZlcnNpb24gPz8gY29uZmlnQm90LnRhZ3MucGF0dGVyblZlcnNpb247Cn0KCi8vdGFyZ2V0ZWQgdmVyc2lvbnMKaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gJiYgKG92by50YWdzLmFiSUQgPT0gY29uZmlnQm90LnRhZ3MucGF0dGVybiB8fCBvdm8udGFncy5hYklEID09IGNvbmZpZ0JvdC50YWdzLmFiIHx8ICFpc05hTihjb25maWdCb3QudGFncy52ZXJzaW9uKSkpCnsKICAgIGlmIChjb25maWdCb3QudGFncy52ZXJzaW9uID09ICJmZWVkYmFjayIpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IG92by50YWdzLmZlZWRiYWNrVmVyc2lvbjsKICAgIH0KICAgIGVsc2UgaWYgKGNvbmZpZ0JvdC50YWdzLnZlcnNpb24gPT0gImN1cnJlbnQiKQogICAgewogICAgICAgIHRhcmdldFZlcnNpb24gPSBvdm8udGFncy5lZ2dWZXJzaW9uSGlzdG9yeS5sZW5ndGg7CiAgICB9CiAgICBlbHNlIGlmICghaXNOYU4oY29uZmlnQm90LnRhZ3MudmVyc2lvbikpCiAgICB7CiAgICAgICAgdGFyZ2V0VmVyc2lvbiA9IGNvbmZpZ0JvdC50YWdzLnZlcnNpb24KICAgIH0KfQoKaWYgKGlzTmFOKHRhcmdldFZlcnNpb24pKQp7CiAgICB0YXJnZXRWZXJzaW9uID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3RvcnkubGVuZ3RoOwp9CgpsZXQgdmVyc2lvbkFycmF5ID0gb3ZvLnRhZ3MuZWdnVmVyc2lvbkhpc3Rvcnk7CmxldCBmaWxlVVJMID0gdmVyc2lvbkFycmF5W3RhcmdldFZlcnNpb24gLSAxXTsKbGV0IGtleSA9IG92by50YWdzLmtleSA/IG92by50YWdzLmtleSA6IGNvbmZpZ0JvdC50YWdzLmtleTsKbGV0IGZpbGVHZXQ7CgovL2FjdHVhbCBmaWxlIHJldHJpZXZhbAp0cnkKewogICAgZmlsZUdldCA9IGF3YWl0IG9zLmdldEZpbGUoZmlsZVVSTCk7Cn0KY2F0Y2ggKGVycm9yKQp7CiAgICBjb25zb2xlLmxvZyhlcnJvcik7CgogICAgb3MudG9hc3QoIm5vIGZpbGUgZm91bmQiKTsKCiAgICByZXR1cm47Cn0KCi8vaGFuZGxpbmcgZm9yIGVuY3J5cHRlZCBhYiBmaWxlCmlmIChjcnlwdG8uaXNFbmNyeXB0ZWQoZmlsZUdldCkpCnsKICAgIGlmICgha2V5KQogICAgewogICAgICAgIGtleSA9IGF3YWl0IG9zLnNob3dJbnB1dCgnJywgewogICAgICAgICAgICB0eXBlOiAnc2VjcmV0JywKICAgICAgICAgICAgdGl0bGU6ICdFbnRlciBrZXknCiAgICAgICAgfSk7CiAgICB9CgogICAgdHJ5CiAgICB7CiAgICAgICAgZmlsZUdldCA9IGNyeXB0by5kZWNyeXB0KGtleSwgZmlsZUdldCk7CiAgICB9CiAgICBjYXRjaCAoZXJyb3IpCiAgICB7CiAgICAgICAgY29uc29sZS5sb2coZXJyb3IpCgogICAgICAgIG9zLnRvYXN0KCJrZXkgZG9lcyBub3QgbWF0Y2ggZmlsZSIpOwoKICAgICAgICByZXR1cm47CiAgICB9CiAgIAogICAgZmlsZUdldCA9IEpTT04ucGFyc2UoZmlsZUdldCk7CgogICAgZmlsZUdldCA9IGZpbGVHZXQuc3RhdGU7Cn0KZWxzZQp7CiAgICBmaWxlR2V0ID0gZmlsZUdldC5zdGF0ZTsKfQoKLy9jbGVhbiB1cApkZXN0cm95KG92byk7CgovL3RvYXN0IGlmIG5vdCBvbiBzdGFibGUKaWYob3ZvLnRhZ3Muc3RhYmxlVmVyc2lvbiAhPSB0YXJnZXRWZXJzaW9uKQp7CiAgICBpZiAob3ZvLnRhZ3MuZmVlZGJhY2tWZXJzaW9uID09IHRhcmdldFZlcnNpb24pCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWRpbmcgZmVlZGJhY2sgdmVyc2lvbiBvZiAiICsgb3ZvLnRhZ3MuYWJJRCk7CiAgICB9CiAgICBlbHNlCiAgICB7CiAgICAgICAgb3MudG9hc3QoImxvYWRpbmcgdmVyc2lvbiAiICsgdGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92by50YWdzLmVnZ1ZlcnNpb25IaXN0b3J5Lmxlbmd0aCArICIgb2YgIiArIG92by50YWdzLmFiSUQpOwogICAgfQp9CgovL2dlbmVyYXRlIGJvdHMgYmFzZWQgb24gdGhlIGZpbGUgcmV0cmlldmVkCmxpbmtzLmNyZWF0ZS5hYkNyZWF0ZUJvdHMoe2JvdHM6IGZpbGVHZXQsIG9yaWdpbjogb3ZvLnRhZ3MuYWJJRCwgdmVyc2lvbjogdGFyZ2V0VmVyc2lvbiwgaW5pdGlhbEJvb3Q6IGluaXRpYWxCb290fSk7JwD4+YzWB53zAQtpbnRlcmFjdE92bwIEAPj5jNYHkb8CjgdALy9tYW51YWwgaGF0Y2ggbWVudQpjb25zdCBvdm9Cb3QgPSB0aGF0ID8gdGhhdCA6IGxpbmtzLm92b0JvdDsKCmlmICghb3ZvQm90KQp7CiAgICByZXR1cm47Cn0KCnNob3V0KCJvdm9NZW51UmVzZXQiKTsKCmNvbmZpZ0JvdC5tYXNrcy5tZW51UG9ydGFsID0gIm92byI7CgptYXNrcy5vbkdyaWRDbGljayA9IGBAIHNob3V0KCJvdm9NZW51UmVzZXQiKTtgOwptYXNrcy5vdm9NZW51UmVzZXQgPSBgQCBtYXNrcy5vbkdyaWRDbGljayA9IG51bGw7Cm1hc2tzLm92b01lbnVSZXNldCA9IG51bGw7Cgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9IG51bGw7CmA7CgpsZXQgZWdnTWVudUJ1dHRvbiA9IHt9OwoKb3MudHdlZW5Ubyhvdm9Cb3QsIDE1LDQ1LDQ1LCA1KTsKCmVnZ01lbnVCdXR0b24ub3ZvID0gdHJ1ZTsKZWdnTWVudUJ1dHRvbi5tYW5hZ2VyID0gIvCflJciICsgdGhpc0JvdC5pZDsKZWdnTWVudUJ1dHRvbi5vdm9Cb3QgPSAi8J+UlyIgKyBvdm9Cb3QuaWQ7CmVnZ01lbnVCdXR0b24udGFyZ2V0VmVyc2lvbiA9IG92b0JvdC50YWdzLnRhcmdldFZlcnNpb247CmVnZ01lbnVCdXR0b24ubGFiZWwgPSAiaGF0Y2ggIiArIG92b0JvdC50YWdzLmFiSUQgKyAiIHYiICsgb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiArICIgb2YgIiArIG92b0JvdC50YWdzLm1heFZlcnNpb247CmVnZ01lbnVCdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKZWdnTWVudUJ1dHRvbi5vdm9NZW51UmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7CmVnZ01lbnVCdXR0b24uY29sb3IgPSAiI0ZGRkZGRiI7CmVnZ01lbnVCdXR0b24ub25DbGljayA9ICJAIGxpbmtzLm1hbmFnZXIuaGF0Y2hPdm8obGlua3Mub3ZvQm90KTsiOwoKbGlua3MubWVudS5hYkNyZWF0ZU1lbnVCdXR0b24oZWdnTWVudUJ1dHRvbik7JwD4+YzWB53zAQZjcmVhdGUCBAD4+YzWB5zGAijwn5SXMzRjM2MyMTAtNWJmMS00OWNmLWIxNTEtZWUyZDA3ZjBlNjczJwD4+YzWB53zARBjaGFuZ2VPdm9WZXJzaW9uAgQA+PmM1gfDxgLwAkAvL2xvZ2ljIGZvciB2ZXJzaW9uIGNoYW5naW5nIHdoZW4gbWFudWFsbHkgaGF0Y2hpbmcgYW4gYWIKY29uc3Qgb3ZvQm90ID0gbGlua3Mub3ZvQm90OwoKbGV0IG5ld1ZlcnNpb24gPSBhd2FpdCBvcy5zaG93SW5wdXQob3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiwgewogICAgcGxhY2Vob2xkZXI6ICJlbnRlciBhIHZlcnNpb24gZnJvbSAxIHRvICIgKyBvdm9Cb3QudGFncy5tYXhWZXJzaW9uCn0pOwoKb3ZvQm90LnRhZ3MudGFyZ2V0VmVyc2lvbiA9IG5ld1ZlcnNpb247Cm92b0JvdC50YWdzLmxhYmVsID0gJ3YnKyBuZXdWZXJzaW9uOwoKY29uZmlnQm90LnRhZ3MudmVyc2lvbiA9IG5ld1ZlcnNpb247CgpzaG91dCgib3ZvTWVudVJlc2V0Iik7JwD4+YzWB53zAQRtZW51AgQA+PmM1ge0yQIo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA+PmM1ged8wEIYWJJZ25vcmUCBAD4+YzWB9vJAgR0cnVlKAD4+YzWB53zAQxhYkJvdFZlcnNpb24BfagCJwD4+YzWB53zAQdhYlNoZWxsAgQA+PmM1gfhyQIEdHJ1ZScA+PmM1ged8wEMYWIxTFRNU2VhcmNoAgQA+PmM1gfmyQIzQC8vc3VwcG9ydCBvbGQgc3ludGF4CnRoaXNCb3Qub25Mb29rdXBBQkVnZ3ModGhhdCk7JwD4+YzWB53zAQ1vbkxvb2t1cEFza0lEAgQA+PmM1geaygLQBUBsZXQgcHJvZ3Jlc3NCdXR0b24gPSBhd2FpdCBsaW5rcy5pbnB1dC5hYlByb2dyZXNzQmFyKGBsb29raW5nIHVwICR7dGhhdC5hc2tJRH1gKTsKCmNvbnN0IGFza0lEID0gImFza18iICsgdGhhdC5hc2tJRDsKY29uc3QgZW5kcG9pbnQgPSBsaW5rcy5yZW1lbWJlci50YWdzLmFiRW5kcG9pbnQ7CmxldCBsb29rdXBBc2s7IAoKdHJ5CnsKICAgIGxvb2t1cEFzayA9IGF3YWl0IG9zLmdldERhdGEobGlua3MucmVtZW1iZXIudGFncy5hYlJlY29yZEtleSwgYXNrSUQsIGVuZHBvaW50KTsKfQpjYXRjaAp7CiAgICBsb29rdXBBc2sgPSBhd2FpdCBvcy5nZXREYXRhKGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJSZWNvcmRLZXksIHRoYXQuYXNrSUQsIGVuZHBvaW50KTsKfQoKaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmIGxvb2t1cEFzay5kYXRhLnBhdHRlcm5JRCkKewogICAgdGhpc0JvdC5vbkxvb2t1cEFCRWdncyh7YWJJRDogbG9va3VwQXNrLmRhdGEucGF0dGVybklELCByZWNvcmRLZXk6IGxvb2t1cEFzay5kYXRhLnN0dWRpb0lELCBhdXRvSGF0Y2g6IHRydWV9KTsgIAp9CmVsc2UgaWYgKGxvb2t1cEFzay5zdWNjZXNzICYmICFsb29rdXBBc2suZGF0YS51cmwpCnsKICAgIGxvb2t1cEFzay5zdWNjZXNzID0gIWxvb2t1cEFzay5zdWNjZXNzOwp9CgppZiAocHJvZ3Jlc3NCdXR0b24pCnsKICAgIGRlc3Ryb3kocHJvZ3Jlc3NCdXR0b24pOwp9CgpyZXR1cm4gbG9va3VwQXNrOycA+PmM1ged8wEFaW5wdXQCBAD4+YzWB+vPAijwn5SXZjg2MDI4NzgtYzJlZi00OGJkLTg1YTAtOGQ2MzUxZWI0MTIwJwEEYm90cyRmODYwMjg3OC1jMmVmLTQ4YmQtODVhMC04ZDYzNTFlYjQxMjABJwD4+YzWB5LQAgZzeXN0ZW0CBAD4+YzWB5PQAg5hYi5zaGVsbC5pbnB1dCcA+PmM1geS0AIEZm9ybQIEAPj5jNYHotACB25vdGhpbmcnAPj5jNYHktACCW9uS2V5RG93bgIEAPj5jNYHqtACbUAvL2FsbG93IHB1bGxpbmcgdXAgY2hhdCBpbiBidWlsZGVyIHZlcnNpb24KaWYgKHRoYXQua2V5cyA9PSAiYCIgJiYgYnVpbGRlclZlcnNpb24pCnsKICAgIG9zLnNob3dDaGF0KCI+Iik7Cn0nAPj5jNYHktACBm9uQ2hhdAIEAPj5jNYHmNEC0CNALy9ub3Qgc3VwcG9ydGVkIG91dHNpZGUgb2YgYnVpbGRlciB2ZXJzaW9uCmlmICghYnVpbGRlclZlcnNpb24pCnsKICAgIHJldHVybjsKfQoKLy90aGlzIGxvb3AgaWRlbnRpZmllcyBwb3NzaWJsZSBhYiBzcGVjaWZpYyBtZXNzYWdlcywgYW5kIGNhbGxzIGEgc2V0IGxpc3Qgb2YgY29tbWFuZHMKaWYgKHRoYXQubWVzc2FnZVswXSA9PSAiLiIpIAp7CiAgICBvcy5oaWRlQ2hhdCgpOwoKICAgIHN3aXRjaCAodGhhdC5tZXNzYWdlKQogICAgewogICAgICAgIGNhc2UgJy5kb3dubG9hZEFCJzoKICAgICAgICAgICAgY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkFzbGVlcCIsICJhYk1hbmlmZXN0U3RhdGUiKTsKCiAgICAgICAgICAgIGNvbnN0IGdyb3VwID0gYXdhaXQgb3Muc2hvd0lucHV0KCJncm91cCIpOwoKICAgICAgICAgICAgaWYgKGdyb3VwID09ICJhYkNvbmZpZyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJDb3JlSXRlcmF0aW9uKys7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmluaXRpYWxCb290ID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuY29yZUFCID0gbnVsbDsKICAgICAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuaG9zdElEID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIGlmIChncm91cCA9PSAiYWJDb3JlIikKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgbGlua3MubGVhcm4udGFncy5hYkluc3QgPSBudWxsOwogICAgICAgICAgICB9CgogICAgICAgICAgICBjb25zdCBhYkdyb3VwID0gZ2V0Qm90cyhncm91cCk7CgogICAgICAgICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFiR3JvdXAubGVuZ3RoOyBpKyspCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGFiR3JvdXBbaV0udGFncy5hYkJvdFZlcnNpb24rKzsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgb3MuZG93bmxvYWRCb3RzQXNJbml0aWFsemF0aW9uVXBkYXRlKGFiR3JvdXAsIGdyb3VwKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLmxvYWRTa2lsbGA6CiAgICAgICAgICAgIGxldCBza2lsbCA9IGF3YWl0IG9zLnNob3dJbnB1dCgic2tpbGwiKTsKCiAgICAgICAgICAgIGxpbmtzLmxlYXJuLmFiQWRhcHQoc2tpbGwpOwogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGAuc3lzdGVtYDoKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3Muc3lzdGVtUG9ydGFsID0gdHJ1ZTsKCiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgYC5zaGVldGA6CiAgICAgICAgICAgIGNvbmZpZ0JvdC50YWdzLnNoZWV0UG9ydGFsID0gIWNvbmZpZ0JvdC50YWdzLm1hcFBvcnRhbCA/IGNvbmZpZ0JvdC50YWdzLmdyaWRQb3J0YWwgOiBjb25maWdCb3QudGFncy5tYXBQb3J0YWw7CgogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGAubWVudVNoZWV0YDoKICAgICAgICAgICAgY29uZmlnQm90LnRhZ3Muc2hlZXRQb3J0YWwgPSBjb25maWdCb3QudGFncy5tZW51UG9ydGFsOwoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLmRvd25sb2FkYDoKICAgICAgICAgICAgb3MuZG93bmxvYWRCb3RzKGdldEJvdHMoYnlNb2Qoe3NwYWNlOiAic2hhcmVkIiwgYWJJZ25vcmU6IG51bGx9KSksIG9zLmdldEN1cnJlbnRJbnN0KCkpOwoKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSBgLnVwbG9hZGA6CiAgICAgICAgICAgIG9zLnNob3dVcGxvYWRBdXhGaWxlKCk7CgogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlIGAuc2xlZXBgOgogICAgICAgICAgICBjaGFuZ2VTdGF0ZShsaW5rcy5tYW5pZmVzdGF0aW9uLCAiQXNsZWVwIiwgImFiTWFuaWZlc3RTdGF0ZSIpOwoKICAgICAgICAgICAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwogICAgICAgICAgICBjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gbnVsbDsKICAgICAgICAgICAgY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCiAgICAgICAgICAgIHRhZ1BvcnRhbEJvdC5tYXNrcy50YWdQb3J0YWxBbmNob3JQb2ludCA9IG51bGw7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgYC4uYDoKICAgICAgICBjYXNlIGAud2FrZWA6CgogICAgICAgICAgICBsZXQgc2tpbGxBcnJheSA9IFsiYWJJbnRlcmZhY2UiLCAiYWJBY3Rpb24iLCAiYWJUZXN0cyJdOwoKICAgICAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBza2lsbEFycmF5Lmxlbmd0aDsgaSsrKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBhd2FpdCBsaW5rcy5sZWFybi5hYkFkYXB0KHNraWxsQXJyYXlbaV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBhd2FpdCBvcy5zbGVlcCgzMDApOwoKICAgICAgICAgICAgLy9rZWVwIGFiIGF3YWtlCiAgICAgICAgICAgIGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJBd2FrZVN0YXRlID0gdHJ1ZTsKCiAgICAgICAgICAgIGlmIChjb25maWdCb3QudGFncy5wYXR0ZXJuKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IGNvbmZpZ0JvdC50YWdzLnBhdHRlcm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBsaW5rcy5yZW1lbWJlci50YWdzLmJhc2VBQiA9IHV1aWQoKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgY2hhbmdlU3RhdGUobGlua3MubWFuaWZlc3RhdGlvbiwgIkF3YWtlIiwgImFiTWFuaWZlc3RTdGF0ZSIpOwogICAgICAgICAgICAKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgY2FzZSAnLmxvZyc6CiAgICAgICAgICAgIGlmIChjb25maWdCb3QudGFncy50YWdQb3J0YWwgPT0gYWIuaWQgKyAiLmFza0xvZyIpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwogICAgICAgICAgICAgICAgY29uZmlnQm90Lm1hc2tzLnRhZ1BvcnRhbFNwYWNlID0gbnVsbDsKCiAgICAgICAgICAgICAgICB0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSBudWxsOwoKICAgICAgICAgICAgICAgIG9zLmhpZGVDaGF0KCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBjb25maWdCb3QubWFza3MudGFnUG9ydGFsID0gYWIuaWQgKyAiLmFza0xvZyI7CiAgICAgICAgICAgICAgICBjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSAidGVtcExvY2FsIjsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgdGFnUG9ydGFsQm90LnRhZ3MudGFnUG9ydGFsU2hvd0J1dHRvbiA9IHRydWU7CiAgICAgICAgICAgICAgICB0YWdQb3J0YWxCb3QudGFncy5pbnB1dCA9IGdldExpbmsodGhpc0JvdCk7CiAgICAgICAgICAgICAgICB0YWdQb3J0YWxCb3QudGFncy5vbkNsaWNrID0gYEAgbGlua3MuaW5wdXQub25DaGF0KHttZXNzYWdlOiAiLmxvZyJ9KTtgOwogICAgICAgICAgICAgICAgdGFnUG9ydGFsQm90LnRhZ3MudGFnUG9ydGFsQnV0dG9uSWNvbiA9ICJ3ZWJfYXNzZXQiOwoKICAgICAgICAgICAgICAgIGlmIChncmlkUG9ydGFsQm90LnRhZ3MucGl4ZWxXaWR0aCA+IGdyaWRQb3J0YWxCb3QudGFncy5waXhlbEhlaWdodCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0YWdQb3J0YWxCb3QubWFza3MudGFnUG9ydGFsQW5jaG9yUG9pbnQgPSAibGVmdCI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gInRvcCI7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgbGlua3MubWFuaWZlc3RhdGlvbi5hc2tCdXR0b24oKTsKICAgICAgICAgICAgICAgIC8vb3Muc2hvd0NoYXQoKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBjYXNlICcuaGlkZUxvZyc6CiAgICAgICAgICAgIGNvbmZpZ0JvdC5tYXNrcy50YWdQb3J0YWwgPSBudWxsOwogICAgICAgICAgICBjb25maWdCb3QubWFza3MudGFnUG9ydGFsU3BhY2UgPSBudWxsOwoKICAgICAgICAgICAgdGFnUG9ydGFsQm90Lm1hc2tzLnRhZ1BvcnRhbEFuY2hvclBvaW50ID0gbnVsbDsKCiAgICAgICAgICAgIG9zLmhpZGVDaGF0KCk7CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIGxldCBtZXNzYWdlID0gdGhhdC5tZXNzYWdlOwogICAgICAgICAgICBsZXQgZXhlY3V0YWJsZSA9IG1lc3NhZ2Uuc2xpY2UoMSk7CgogICAgICAgICAgICB0cnkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgb3MucnVuKGV4ZWN1dGFibGUpOyAgCiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2F0Y2ggKGUpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKGUpOwogICAgICAgICAgICB9CiAgICB9Cn0nAPj5jNYHktACC2Rlc2NyaXB0aW9uAgQA+PmM1gfp9AJCVGhpcyBpcyBtZWFudCB0byBoYW5kbGUgYW55IG5vbmUgbWVudSByZWxhdGVkIGlucHV0cy9pbnRlcmFjdGlvbnMuJwD4+YzWB5LQAgxvbkZpbGVVcGxvYWQCBAD4+YzWB6z1AsQUQC8vZmlsdGVyIG91dCB0aW1lcyB3aGVuIGZpbGUgbG9hZGluZyBpcyBub3QgYWxsb3dlZAppZiAoIWJ1aWxkZXJWZXJzaW9uIHx8IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJMaXN0ZW5pbmdGb3JGaWxlVXBsb2FkcyAhPT0gdHJ1ZSkKewogICAgcmV0dXJuOwp9CgovL3ZhcmlvdXMgZmlsZSBzcGVjaWZpYyB2YXJpYWJsZXMKbGV0IGZpbGVFeHRlbnNpb24gPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnBvcCgpOwpsZXQgZmlsZU5hbWUgPSB0aGF0LmZpbGUubmFtZS5zcGxpdCgnLicpLnNoaWZ0KCk7CmxldCBzaXplID0gdGhhdC5maWxlLnNpemU7CmxldCBtaW1lVHlwZTsKbGV0IGJvdEluZm8gPSB7fTsKCi8vaGFyZCBsaW1pdCBiYXNlZCBvbiBmaWxlIHNpemUKaWYgKHNpemUgPiAyMDAwMDAwMDApCnsKICBvcy50b2FzdCgibWF4aW11bSBmaWxlIHNpemUgZXhjZWVkZWQgKDIwMCBtYikiKTsKCiAgcmV0dXJuOwp9CgovL3RoaXMgc3dpdGNoIGhhbmRsZXMgcG9zc2libGUgZmlsZXMgZXh0ZW5zaW9ucywgd2hpbGUgcmVqZWN0aW5nIGFueSBpdCBkb2VzIG5vdCByZWNvZ25pemUKc3dpdGNoKGZpbGVFeHRlbnNpb24pCnsKICBjYXNlICdqcGcnOgogIGNhc2UgJ2pwZWcnOgogIGNhc2UgJ3dlYnAnOgogIGNhc2UgJ2dpZic6CiAgY2FzZSAncG5nJzoKICAgIG1pbWVUeXBlID0gImltYWdlLyIgKyBmaWxlRXh0ZW5zaW9uOwogICAgYm90SW5mby5mb3JtID0gInNwcml0ZSI7CiAgICBicmVhazsKICBjYXNlICdzdmcnOgogICAgbWltZVR5cGUgPSAiaW1hZ2Uvc3ZnK3htbCI7CiAgICBib3RJbmZvLmZvcm0gPSAic3ByaXRlIjsKICAgIGJyZWFrOwogIGNhc2UgJ2dsYic6CiAgY2FzZSAnZXhyJzoKICBjYXNlICdnbHRmJzoKICAgIG1pbWVUeXBlID0gInRleHQveG1sIjsKICAgIGJvdEluZm8uZm9ybSA9ICJtZXNoIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAiZ2x0ZiI7CiAgICBicmVhazsKICBjYXNlICdhdXgnOgogIGNhc2UgJ3BkZic6CiAgICBsZXQgYm90RGF0YSA9IGZpbGVFeHRlbnNpb24gPT0gIi5hdXgiID8gSlNPTi5wYXJzZSh0aGF0LmZpbGUuZGF0YSkuc3RhdGUgOiBvcy5wYXJzZUJvdHNGcm9tRGF0YSh0aGF0LmZpbGUuZGF0YSk7CgogICAgbGlua3MuY3JlYXRlLmFiQ3JlYXRlQm90cyh7Ym90czogYm90RGF0YSwgb3JpZ2luOiBmaWxlTmFtZX0pOwoKICAgIHJldHVybjsKLy8gICBjYXNlICdwZGYnOgovLyAgICAgYnJlYWs7CiAgY2FzZSAnbXAzJzoKICAgIG1pbWVUeXBlID0gJ2F1ZGlvL21wZWcnOwogICAgYm90SW5mby5vbkNsaWNrID0gIkAgb3MucGxheVNvdW5kKHRhZ3MuZm9ybUFkZHJlc3MpOyI7CiAgICBib3RJbmZvLmxhYmVsID0gIkNsaWNrIHRvIFBsYXkiOwogICAgYnJlYWs7CiAgY2FzZSAnbXA0JzoKICAgIG1pbWVUeXBlID0gJ3ZpZGVvL21wNCc7CiAgICBib3RJbmZvLmZvcm0gPSAiaWZyYW1lIjsKICAgIGJvdEluZm8uZm9ybVN1YnR5cGUgPSAic3JjIjsKICAgIGJyZWFrOwogIGRlZmF1bHQ6CiAgICBsZXQgcmVzdWx0ID0gbmV3IEVycm9yKCJ1bmhhbmRsZWQgZmlsZSB0eXBlOiAiICsgZmlsZUV4dGVuc2lvbik7CiAgICBvcy50b2FzdCgiZmlsZSB0eXBlIG5vdCBzdXBwb3J0ZWQiKTsKICAgIGNvbnNvbGUud2FybihyZXN1bHQpCiAgICByZXR1cm4gcmVzdWx0Owp9CgovL3RoZSBmb2xsb3dpbmcgdmFyaWFibGVzIGFuZCBvYmplY3RzIHNldCB1cCBhIGxvYWRpbmcgYmFyIGJ1dHRvbgpjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwoKbGV0IHVwbG9hZFJlc3VsdDsKbGV0IHByb2dyZXNzQnV0dG9uID0gYXdhaXQgdGhpc0JvdC5hYlByb2dyZXNzQmFyKGB1cGxvYWRpbmdgKTsKCmNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gY29uZmlnQm90LnRhZ3Muc3R1ZGlvSUQgPz8gY29uZmlnQm90LnRhZ3Muc3R1ZGlvOwoKaWYgKCFjb25maWdCb3QudGFncy5zZWxlY3RlZF9zdHVkaW9JRCkKewogIGF3YWl0IG9zLnJlcXVlc3RBdXRoQm90KCk7CgogIGNvbmZpZ0JvdC50YWdzLnNlbGVjdGVkX3N0dWRpb0lEID0gYXV0aEJvdC5pZDsKfQoKLy90aGlzIGlzIHRoZSBhY3R1YWwgdXBsb2FkIGZ1bmN0aW9uYWxpdHkKdXBsb2FkUmVzdWx0ID0gYXdhaXQgbGlua3Muc3RvcmUuYWJQdWJsaXNoRmlsZSh7ZmlsZTogdGhhdC5maWxlLmRhdGEsIGZpbGVOYW1lOiBmaWxlTmFtZSwgbWltZVR5cGU6IG1pbWVUeXBlfSk7CgovL2lmIHRoZSBmaWxlIHNob3VsZCBiZSBpbmNsdWRlZCBhcyBhIGJvdCB3aXRoIGEgbGluaywgdGhpcyBsb2dpYyBoYW5kbGVzIHRoYXQKaWYgKE9iamVjdC5rZXlzKGJvdEluZm8pLmxlbmd0aCA+IDApCnsKICAgIGJvdEluZm9bY29uZmlnQm90LnRhZ3MuZ3JpZFBvcnRhbF0gPSB0cnVlOwogICAgYm90SW5mby5mb3JtQWRkcmVzcyA9IHVwbG9hZFJlc3VsdC51cmwgPyB1cGxvYWRSZXN1bHQudXJsIDogdXBsb2FkUmVzdWx0LmV4aXN0aW5nRmlsZVVybDsKCiAgICBjcmVhdGUoYm90SW5mbyk7Cn0KCi8vY2xlYXIgdGhlIHByb2dyZXNzIGJhciBidXR0b24KY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOwoKaWYgKHByb2dyZXNzQnV0dG9uKQp7CiAgZGVzdHJveShwcm9ncmVzc0J1dHRvbik7Cn0KCnJldHVybiB1cGxvYWRSZXN1bHQ7JwD4+YzWB5LQAgVsZWFybgIEAPj5jNYH8YkDKPCflJc2NjU3Yjg2NS1lOTgzLTQ0MDEtOWZjOS1mNTQxOGQxOGE3ZjcnAPj5jNYHktACCHJlbWVtYmVyAgQA+PmM1geYigMo8J+Ul2U1MzgwYTZiLThiNGQtNGE4Yi04YjA0LTU4ZTFlYjAzZTVlNycA+PmM1geS0AINbWFuaWZlc3RhdGlvbgIEAPj5jNYHv4oDKPCflJdkY2E1ZDk4Ny1jNGQ4LTQ2ZTQtYjYwYy1kYWE3YjJmNGRkYWQnAPj5jNYHktACCGFiSWdub3JlAgQA+PmM1gfmigMEdHJ1ZSgA+PmM1geS0AIMYWJCb3RWZXJzaW9uAX2oAicA+PmM1geS0AIGY3JlYXRlAgQA+PmM1gfsigMo8J+UlzM0YzNjMjEwLTViZjEtNDljZi1iMTUxLWVlMmQwN2YwZTY3MycA+PmM1geS0AIFc3RvcmUCBAD4+YzWB5OLAyjwn5SXNzZhZjA0OTEtMzkxOS00OTg0LWFhODItMjJjNzQyZjQyNjNmJwD4+YzWB5LQAgRtZW51AgQA+PmM1ge6iwMo8J+Ul2IzMGM2YzVkLWE0ZjctNDI2Ni1iYTM4LTM5M2RjOTVlMWVjYicA+PmM1geS0AIHYWJTaGVsbAIEAPj5jNYH4YsDBHRydWUnAPj5jNYHktACDWFiUHJvZ3Jlc3NCYXICBAD4+YzWB+aLA98IQGlmICghY29uZmlnQm90LnRhZ3MuYWJTaWxlbnRNb2RlKQp7CiAgICBjb25maWdCb3QubWFza3MubWVudVBvcnRhbCA9ICJhYk1lbnUiOwp9CgpsZXQgbG9hZExhYmVsID0gdGhhdCA/PyAidXBkYXRpbmciOwpsZXQgbWVudUJ1dHRvbiA9IHt9OwoKbWVudUJ1dHRvbi5zcGFjZSA9ICJ0ZW1wTG9jYWwiOwptZW51QnV0dG9uLmFiTWVudSA9IHRydWU7Cm1lbnVCdXR0b24ubWVudUl0ZW1TdHlsZSA9IHsgImJvcmRlci1yYWRpdXMiOiI4cHgiLCAibWFyZ2luLXRvcCI6IjNweCJ9OwptZW51QnV0dG9uLnRyYWNrTnVtID0gLTE7Cm1lbnVCdXR0b24ub25DcmVhdGUgPSBgQAogICAgaWYgKHRhZ3MudHJhY2tOdW0gPT0gMikKICAgIHsKICAgICAgICB0YWdzLnRyYWNrTnVtID0gMDsKICAgIH0KICAgIGVsc2UKICAgIHsKICAgICAgICB0YWdzLnRyYWNrTnVtKys7CiAgICB9CgogICAgdGFncy5sYWJlbCA9IHRhZ3NbImxhYmVsIit0YWdzLnRyYWNrTnVtXTsKICAgIHRhZ3MuZm9ybUFkZHJlc3MgPSB0YWdzWyJmb3JtIit0YWdzLnRyYWNrTnVtXTsKCiAgICBzZXRUaW1lb3V0KCgpID0+IHdoaXNwZXIodGhpc0JvdCwgIm9uQ3JlYXRlIiksIDUwMCk7YDsKbWVudUJ1dHRvbi5sYWJlbDAgPSBsb2FkTGFiZWwgKyAiLiI7Cm1lbnVCdXR0b24ubGFiZWwxID0gbG9hZExhYmVsICsgIi4uIjsKbWVudUJ1dHRvbi5sYWJlbDIgPSBsb2FkTGFiZWwgKyAiLi4uIjsKbWVudUJ1dHRvbi5mb3JtMCA9ICJob3VyZ2xhc3NfYm90dG9tIjsKbWVudUJ1dHRvbi5mb3JtMSA9ICJob3VyZ2xhc3NfdG9wIjsKbWVudUJ1dHRvbi5mb3JtMiA9ICJob3VyZ2xhc3NfYm90dG9tIjsKbWVudUJ1dHRvbi5jb2xvciA9IGxpbmtzLnJlbWVtYmVyLnRhZ3MuYWJCYXNlU3Ryb2tlQ29sb3I7Cm1lbnVCdXR0b24ubGFiZWxDb2xvciA9ICJibGFjayI7Cm1lbnVCdXR0b24ubGFiZWxBbGlnbm1lbnQgPSAiY2VudGVyIjsKbWVudUJ1dHRvbi5hYlByb2dyZXNzUmVzZXQgPSAiQCBkZXN0cm95KHRoaXNCb3QpOyI7Cm1lbnVCdXR0b24ub25EZXN0cm95ID0gIkAgY29uZmlnQm90Lm1hc2tzLm1lbnVQb3J0YWwgPSBudWxsOyI7CgptZW51QnV0dG9uID0gY3JlYXRlKG1lbnVCdXR0b24pOwoKcmV0dXJuIG1lbnVCdXR0b247JwD4+YzWB5LQAglvblRhcENvZGUCBAD4+YzWB8aUA9wBQGNvbnN0IHRhcENvZGUgPSB0aGF0OwoKc3dpdGNoICh0YXBDb2RlKQp7CiAgICBjYXNlICIzMzQyIjoKICAgICAgICB0aGlzQm90Lm9uQ2hhdCh7bWVzc2FnZTogIi4uIn0pOwogICAgICAgIGJyZWFrOwogICAgY2FzZSAiNDI0MiI6CiAgICAgICAgb3Muc2hvd0NoYXQoIj4iKTsKICAgICAgICBicmVhazsKICAgIGRlZmF1bHQ6CiAgICAgICAgLy9jb25zb2xlLmxvZyh0YXBDb2RlKTsKfQA="}]}